<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>shaoxiang博客</title>
  
  <subtitle>我的博客</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://yangshaoxiang.github.io/"/>
  <updated>2018-03-20T12:49:16.418Z</updated>
  <id>https://yangshaoxiang.github.io/</id>
  
  <author>
    <name>yangshaoxiang</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>APM(4)javassist结合javaagent使用</title>
    <link href="https://yangshaoxiang.github.io/2018/03/15/APM(4)javassist%E7%BB%93%E5%90%88javaagent%E4%BD%BF%E7%94%A8/"/>
    <id>https://yangshaoxiang.github.io/2018/03/15/APM(4)javassist结合javaagent使用/</id>
    <published>2018-03-15T12:31:26.000Z</published>
    <updated>2018-03-20T12:49:16.418Z</updated>
    
    <content type="html"><![CDATA[<p>javaagnet为插桩提供入口，javassist实现字节码修改，这部分将记录3个demo，分别是静态agent结合javassist修改方法体，动态agent结合javassist修改方法体，最后一个demo综合使用javaagent和javassist监听c3p0数据源<br><a id="more"></a></p><h4 id="静态agent修改方法"><a href="#静态agent修改方法" class="headerlink" title="静态agent修改方法"></a>静态agent修改方法</h4><ol><li><p>编写一个用于被篡改的类Calculate，示例代码如下:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Calculate</span> </span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">    * 输入什么数字就返回什么数字</span></div><div class="line"><span class="comment">    * <span class="doctag">@param</span> a 输入的数字</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> 输入的数字</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getResult</span><span class="params">(<span class="keyword">int</span> a)</span></span>&#123;</div><div class="line">       <span class="keyword">return</span> a;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>编写ClassTransform的实现类和静态agent类，配置pom文件(参考 <a href="https://yangshaoxiang.github.io/2018/03/07/APM(1)%E9%9D%99%E6%80%81javaagent%E4%BD%BF%E7%94%A8/#more" title="静态javaagent使用">APM1</a> ),该类在Calculate类进行装载时会篡改他的字，使得他的getResult()方法返回输入数值的双倍，完毕后记得打包，示例代码如下:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.transformer;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javassist.*;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.lang.instrument.ClassFileTransformer;</div><div class="line"><span class="keyword">import</span> java.lang.instrument.IllegalClassFormatException;</div><div class="line"><span class="keyword">import</span> java.security.ProtectionDomain;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FirstAhentTransformer</span>  <span class="keyword">implements</span> <span class="title">ClassFileTransformer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="keyword">byte</span>[] classfileBuffer) <span class="keyword">throws</span> IllegalClassFormatException &#123;</div><div class="line">        String modifyClassName1 = <span class="string">"com/pojo/Calculate"</span>;<span class="comment">//要修改的类</span></div><div class="line">        String modifyClassName = <span class="string">"com.pojo.Calculate"</span>;<span class="comment">//要修改的类</span></div><div class="line">        <span class="keyword">if</span>(modifyClassName1.equals(className))&#123;</div><div class="line">            ClassPool pool = <span class="keyword">new</span> ClassPool();</div><div class="line">            LoaderClassPath loaderClassPath = <span class="keyword">new</span> LoaderClassPath(loader);</div><div class="line">            pool.insertClassPath(loaderClassPath);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                CtClass ctClass = pool.get(modifyClassName);</div><div class="line">                CtMethod resultMethod = ctClass.getDeclaredMethod(<span class="string">"getResult"</span>);</div><div class="line">                <span class="comment">//添加一行a = 2*a;，如果成功该方法返回值应该是2a</span></div><div class="line">                resultMethod.insertBefore(<span class="string">"$1 = 2*$1;"</span>);</div><div class="line">                <span class="keyword">return</span> ctClass.toBytecode();</div><div class="line">            &#125; <span class="keyword">catch</span> (NotFoundException e) &#123;</div><div class="line">                System.out.println(<span class="string">"类没找到"</span>);</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125; <span class="keyword">catch</span> (CannotCompileException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//返回一个null表示，仍然装载之前的class，agent并没有对类进行修改</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.agenttest;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javassist.*;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.lang.instrument.ClassFileTransformer;</div><div class="line"><span class="keyword">import</span> java.lang.instrument.IllegalClassFormatException;</div><div class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</div><div class="line"><span class="keyword">import</span> java.security.ProtectionDomain;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FirstAgent</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> arg agentArgs 是 premain 函数得到的程序参数，随同 “– javaagent”一起传入。</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> instrumentation instrumentation 是一个 java.lang.instrument.Instrumentation 的实例，由 JVM 自动传入</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String arg, Instrumentation instrumentation)</span></span>&#123;</div><div class="line">      System.out.println(<span class="string">"这里执行了premain()方法，进行了装载"</span>);</div><div class="line">      instrumentation.addTransformer(<span class="keyword">new</span> FirstAhentTransformer());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ol><li><p>启动方法，测试，注意添加javagent的jvm启动参数，示例代码如下:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.test;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.pojo.Calculate;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FirstAgentMain</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">            System.out.println(<span class="string">"main方法中的输出"</span>);</div><div class="line">            <span class="keyword">int</span> result = Calculate.getResult(<span class="number">100</span>);</div><div class="line">            System.out.println(<span class="string">"输入100获取到的值是:"</span>+result);</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>结果输出及结论:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">这里执行了premain()方法，进行了装载</div><div class="line">main方法中的输出</div><div class="line">输入100获取到的值是:200</div></pre></td></tr></table></figure></li></ol><p>在main方法调用Calculate类时，Calculate进行加载，加载过程中被agent类修改了字节码实现，agent类中，instrumentation.addTransformer()方法中返回修改后的字节码，若该方法返回值不为空，则虚拟机会加载该方法返回的字节码，若为空则使用原来的字节码，这里在该方法中使用javassist修改了Calculate类的getResult方法，因此当main方法中执行Calculate.getResult()方法时，此时加载的Calculate类是修改后的，因此正常输出100现在是200，其实这也相当于对Calculate类进行了代理</p><h4 id="动态agent修改方法"><a href="#动态agent修改方法" class="headerlink" title="动态agent修改方法"></a>动态agent修改方法</h4><ol><li><p>编写被篡改的类Calculate，该类代码和上面相同，这里不在重复编写</p></li><li><p>ClassTransform的实现类同上，动态agent类示例代码如下:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicAgent</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">agentmain</span><span class="params">(String arg, Instrumentation instrumentation)</span></span>&#123;</div><div class="line">        System.out.println(<span class="string">"这里执行了agentmain()方法，进行了装载"</span>);</div><div class="line">        instrumentation.addTransformer(<span class="keyword">new</span> FirstAhentTransformer(),<span class="keyword">true</span>);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            instrumentation.retransformClasses(Calculate.class);</div><div class="line">        &#125; <span class="keyword">catch</span> (UnmodifiableClassException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></li><li><p>添加pom相关依赖，打成jar包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                 <span class="tag">&lt;<span class="name">archive</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">manifestEntries</span>&gt;</span></div><div class="line">                         <span class="tag">&lt;<span class="name">Project-name</span>&gt;</span>$&#123;project.name&#125;<span class="tag">&lt;/<span class="name">Project-name</span>&gt;</span></div><div class="line">                         <span class="tag">&lt;<span class="name">Project-version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">Project-version</span>&gt;</span></div><div class="line">                         <span class="tag">&lt;<span class="name">Premain-Class</span>&gt;</span>com.agenttest.FirstAgent<span class="tag">&lt;/<span class="name">Premain-Class</span>&gt;</span></div><div class="line">                         <span class="tag">&lt;<span class="name">Boot-Class-Path</span>&gt;</span>javassist-3.18.1-GA.jar<span class="tag">&lt;/<span class="name">Boot-Class-Path</span>&gt;</span></div><div class="line">                         <span class="tag">&lt;<span class="name">Agent-Class</span>&gt;</span>com.agenttest.DynamicAgent<span class="tag">&lt;/<span class="name">Agent-Class</span>&gt;</span></div><div class="line">                         <span class="tag">&lt;<span class="name">Can-Redefine-Classes</span>&gt;</span>true<span class="tag">&lt;/<span class="name">Can-Redefine-Classes</span>&gt;</span></div><div class="line">                         <span class="tag">&lt;<span class="name">Can-Retransform-Classes</span>&gt;</span>true<span class="tag">&lt;/<span class="name">Can-Retransform-Classes</span>&gt;</span></div><div class="line">                         <span class="comment">&lt;!--&lt;Main-Class&gt;com.test.DynamicAgentJarTest&lt;/Main-Class&gt;--&gt;</span></div><div class="line">                     <span class="tag">&lt;/<span class="name">manifestEntries</span>&gt;</span></div><div class="line">                 <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></div><div class="line">                 <span class="tag">&lt;<span class="name">skip</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skip</span>&gt;</span></div><div class="line">             <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">         <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div></pre></td></tr></table></figure></li></ol><p>注意这里相比于 <a href="https://yangshaoxiang.github.io/2018/03/09/APM(2)%E5%8A%A8%E6%80%81javaagent%E4%BD%BF%E7%94%A8/" title="动态javaagent使用">APM2</a> 多了两个标签,其含义可以参考<a href="https://yq.aliyun.com/articles/2946?spm=5176.100239.yqblog1.45" target="_blank" rel="external">JVM源码分析之javaagent原理完全解读</a><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Can-Redefine-Classes</span>&gt;</span>true<span class="tag">&lt;/<span class="name">Can-Redefine-Classes</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Can-Retransform-Classes</span>&gt;</span>true<span class="tag">&lt;/<span class="name">Can-Retransform-Classes</span>&gt;</span></div></pre></td></tr></table></figure></p><ol><li><p>编写虚拟机监听器<br>之所以写这个是因为动态atach时不这样做就需要jvm的进程ID，这样就不需要在代码里手动的去改JVN的进程ID了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.agenttest;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.sun.tools.attach.VirtualMachine;</div><div class="line"><span class="keyword">import</span> com.sun.tools.attach.VirtualMachineDescriptor;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VirtualMachineListener</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;VirtualMachineDescriptor&gt; listBefore;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String jar;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">VirtualMachineListener</span><span class="params">(String attachJar, List&lt;VirtualMachineDescriptor&gt; vms)</span> </span>&#123;</div><div class="line">        listBefore = vms;  <span class="comment">// 记录程序启动时的 VM 集合</span></div><div class="line">        jar = attachJar;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        VirtualMachine vm = <span class="keyword">null</span>;</div><div class="line">        List&lt;VirtualMachineDescriptor&gt; listAfter = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                listAfter = VirtualMachine.list();</div><div class="line">                <span class="keyword">for</span> (VirtualMachineDescriptor vmd : listAfter) &#123;</div><div class="line">                    <span class="keyword">if</span> (!listBefore.contains(vmd)) &#123;</div><div class="line">                        <span class="comment">// 如果 VM 有增加，我们就认为是被监控的 VM 启动了</span></div><div class="line">                        <span class="comment">// 这时，我们开始监控这个 VM</span></div><div class="line">                        listBefore.add(vmd);</div><div class="line">                        vm = VirtualMachine.attach(vmd);</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                Thread.sleep(<span class="number">500</span>);</div><div class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != vm ) &#123;</div><div class="line">                    System.out.println(<span class="string">"已监控到目标虚拟机--执行动态atach"</span>);</div><div class="line">                    vm.loadAgent(jar);</div><div class="line">                    vm.detach();</div><div class="line">                    System.out.println(<span class="string">"已监控到目标虚拟机--结束监听"</span>);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">           e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>两个启动测试方法<br>启动虚拟机的监听器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.test;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.agenttest.VirtualMachineListener;</div><div class="line"><span class="keyword">import</span> com.sun.tools.attach.VirtualMachine;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicAgentTest</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span>  Exception </span>&#123;</div><div class="line">        <span class="comment">//动态Agent所在项目打包的jar包</span></div><div class="line">            String jarPath = System.getProperty(<span class="string">"user.dir"</span>) + <span class="string">"/javaagentTestagent/target/javaagentTest-agent-1.0-SNAPSHOT.jar"</span>;</div><div class="line">            System.out.println(<span class="string">"------&gt;"</span>+jarPath);</div><div class="line">            <span class="comment">//启动虚拟机监听器</span></div><div class="line">            <span class="keyword">new</span> VirtualMachineListener(jarPath ,VirtualMachine.list()).start();</div><div class="line">            System.out.println(<span class="string">"atach已启动。。。。"</span>);</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ol><p>启动测试项目<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FirstAgentMain</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">            System.out.println(<span class="string">"main方法中的输出"</span>);</div><div class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Thread.sleep(<span class="number">200</span>);</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">int</span> result = Calculate.getResult(<span class="number">100</span>);</div><div class="line">                System.out.println(<span class="string">"输入值是100，当前获得的结果是:"</span>+result);</div><div class="line">                <span class="keyword">if</span>(result == <span class="number">200</span>)&#123;</div><div class="line">                    System.out.println(<span class="string">"结束循环说明类已被动态修改"</span>);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ol><li><p>结果输出及结论<br>先启动虚拟机监听器，一直监听JVM的启动，之后项目启动，调用getResult可以看到控制台先打印100，监听器监听到项目启动，动态atach到这个JVM上修改getResult()方法后，控制台打印200  </p><p> 监听器的打印:</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">------&gt;C:\软件\代码\smproject\javaagentTest/javaagentTestagent/target/javaagentTest-agent-1.0-SNAPSHOT.jar</div><div class="line">atach已启动。。。。</div><div class="line">##下面的打印是在启动项目后，监听器监听到，然后打印的信息</div><div class="line">已监控到目标虚拟机--执行动态atach</div><div class="line">已监控到目标虚拟机--结束监听</div></pre></td></tr></table></figure><p> 项目的打印:</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">main方法中的输出</div><div class="line">输入值是100，当前获得的结果是:100</div><div class="line">输入值是100，当前获得的结果是:100</div><div class="line">输入值是100，当前获得的结果是:100</div><div class="line">输入值是100，当前获得的结果是:100</div><div class="line">这里执行了agentmain()方法，进行了装载</div><div class="line">输入值是100，当前获得的结果是:100</div><div class="line">输入值是100，当前获得的结果是:200</div><div class="line">结束循环说明类已被动态修改</div></pre></td></tr></table></figure></li></ol><h4 id="监听c3p0数据源"><a href="#监听c3p0数据源" class="headerlink" title="监听c3p0数据源"></a>监听c3p0数据源</h4><p>本次插桩是在com.mchange.v2.c3p0.ComboPooledDataSource类的构造方法中插入System.getProperties().put(“c3p0Source$agent”, $0);<br>保存一个全局的ComboPooledDataSource对象，然后将该对象在页面中输出</p><ol><li>编写ClassTransform的实现类和静态agent类<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">C3p0Agent</span> <span class="keyword">implements</span> <span class="title">ClassFileTransformer</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> String targetClass = <span class="string">"com.mchange.v2.c3p0.ComboPooledDataSource"</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span>  <span class="title">C3p0Agent</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">//打开http服务</span></div><div class="line">            openHttpServer();</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 获取ComboPooledDataSource对象信息</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getStatus</span><span class="params">()</span> </span>&#123;</div><div class="line">        Object source2 = System.getProperties().get(<span class="string">"c3p0Source$agent"</span>);</div><div class="line">        <span class="keyword">if</span> (source2 == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">"未初始任何c3p0数据源"</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> source2.toString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//开启http端口 http://localhost:5555/server</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openHttpServer</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        InetSocketAddress addr = <span class="keyword">new</span> InetSocketAddress(<span class="number">5555</span>);</div><div class="line">        HttpServer server = HttpServer.create(addr, <span class="number">0</span>);</div><div class="line">        server.createContext(<span class="string">"/server"</span>, <span class="keyword">new</span> HttpHandler());</div><div class="line">        server.setExecutor(Executors.newCachedThreadPool());</div><div class="line">        server.start();</div><div class="line">        System.out.println(<span class="string">"Server is listening on port 5555"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 本次插桩是在com.mchange.v2.c3p0.ComboPooledDataSource类的构造方法中插入</span></div><div class="line"><span class="comment">     * System.getProperties().put("c3p0Source$agent", $0);</span></div><div class="line"><span class="comment">     * 保存一个全局的ComboPooledDataSource对象，然后将该对象在页面中输出</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="keyword">byte</span>[] classfileBuffer) <span class="keyword">throws</span> IllegalClassFormatException &#123;</div><div class="line">        <span class="keyword">byte</span>[] result = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (className != <span class="keyword">null</span> &amp;&amp; className.replace(<span class="string">"/"</span>, <span class="string">"."</span>).equals(targetClass)) &#123;</div><div class="line">            ClassPool pool = <span class="keyword">new</span> ClassPool();</div><div class="line">            pool.insertClassPath(<span class="keyword">new</span> LoaderClassPath(loader));</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                CtClass ctl = pool.get(targetClass);</div><div class="line">                <span class="comment">//获取构造方法 ()V无参构造</span></div><div class="line">                CtConstructor constructor = ctl.getConstructor(<span class="string">"()V"</span>);</div><div class="line">                <span class="comment">//$0 表示this</span></div><div class="line">                constructor.insertAfter(<span class="string">"System.getProperties().put(\"c3p0Source$agent\", $0);"</span>);</div><div class="line">                result = ctl.toBytecode();</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpHandler</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">sun</span>.<span class="title">net</span>.<span class="title">httpserver</span>.<span class="title">HttpHandler</span> </span>&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(HttpExchange exchange)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">            Headers responseHeaders = exchange.getResponseHeaders();</div><div class="line">            responseHeaders.set(<span class="string">"Content-Type"</span>, <span class="string">"text/plain;charset=UTF-8"</span>);</div><div class="line">            exchange.sendResponseHeaders(<span class="number">200</span>, <span class="number">0</span>);</div><div class="line">            OutputStream responseBody = exchange.getResponseBody();</div><div class="line">            <span class="comment">// 输出c3p0状态</span></div><div class="line">            responseBody.write(C3p0Agent.<span class="keyword">this</span>.getStatus().getBytes());</div><div class="line">            responseBody.flush();</div><div class="line">            responseBody.close();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String args, Instrumentation inst)</span> </span>&#123;</div><div class="line">    System.out.println(String.format(<span class="string">"系统载入myAgent 参数%s 载入方法:premain"</span>, args));</div><div class="line">    System.out.println(<span class="string">"载入C3p0Agent"</span>);</div><div class="line">    inst.addTransformer(<span class="keyword">new</span> C3p0Agent());</div><div class="line">&#125;</div></pre></td></tr></table></figure><ol><li>编写测试demo</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">C3p0Demo</span> </span>&#123;</div><div class="line">    ComboPooledDataSource dataSource;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">C3p0Demo</span><span class="params">()</span></span>&#123;</div><div class="line">        dataSource = <span class="keyword">new</span> ComboPooledDataSource(<span class="string">"mysql"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exec</span><span class="params">(String sql)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        Connection conn = dataSource.getConnection();</div><div class="line">        <span class="keyword">boolean</span> b = conn.createStatement().execute(sql);</div><div class="line">        conn.close();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        C3p0Demo s=<span class="keyword">new</span> C3p0Demo();</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</div><div class="line">            <span class="keyword">int</span> size = System.in.read(bytes);</div><div class="line">            String sql = <span class="keyword">new</span> String(bytes, <span class="number">0</span>, size);</div><div class="line">            System.out.println(sql);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                s.exec(sql);</div><div class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ol><li>运行测试<br>注意agent类打包，添加pom配置等不在累述，resources下要有c3p0配置文件c3p0-config.xml，运行是添加jvm启动参数</li></ol><p>控制台输出:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">系统载入myAgent 参数null 载入方法:premain</div><div class="line">载入C3p0Agent</div><div class="line">Server is listening on port 5555</div><div class="line">三月 19, 2018 11:07:05 上午 com.mchange.v2.log.MLog &lt;clinit&gt;</div><div class="line">信息: MLog clients using java 1.4+ standard logging.</div><div class="line">三月 19, 2018 11:07:06 上午 com.mchange.v2.c3p0.C3P0Registry banner</div><div class="line">信息: Initializing c3p0-0.9.1.2 [built 21-May-2007 15:04:56; debug? true; trace: 10]</div><div class="line">select * from user;</div><div class="line">select * from user;</div></pre></td></tr></table></figure></p><p>浏览器访问 <a href="http://localhost:5555/server" target="_blank" rel="external">http://localhost:5555/server</a> 页面内容:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">com.mchange.v2.c3p0.ComboPooledDataSource [ acquireIncrement -&gt; 3, acquireRetryAttempts -&gt; 30, acquireRetryDelay -&gt; 1000, autoCommitOnClose -&gt; false, automaticTestTable -&gt; null, breakAfterAcquireFailure -&gt; false, checkoutTimeout -&gt; 0, connectionCustomizerClassName -&gt; null, connectionTesterClassName -&gt; com.mchange.v2.c3p0.impl.DefaultConnectionTester, dataSourceName -&gt; mysql, debugUnreturnedConnectionStackTraces -&gt; false, description -&gt; null, driverClass -&gt; com.mysql.jdbc.Driver, factoryClassLocation -&gt; null, forceIgnoreUnresolvedTransactions -&gt; false, identityToken -&gt; 1hge41t9ugpkfsah1jv37|21934d9d, idleConnectionTestPeriod -&gt; 0, initialPoolSize -&gt; 10, jdbcUrl -&gt; jdbc:mysql://localhost:3306/springtest?useUnicode=true&amp;characterEncoding=UTF8, maxAdministrativeTaskTime -&gt; 0, maxConnectionAge -&gt; 0, maxIdleTime -&gt; 30, maxIdleTimeExcessConnections -&gt; 0, maxPoolSize -&gt; 100, maxStatements -&gt; 200, maxStatementsPerConnection -&gt; 0, minPoolSize -&gt; 10, numHelperThreads -&gt; 3, numThreadsAwaitingCheckoutDefaultUser -&gt; 0, preferredTestQuery -&gt; null, properties -&gt; &#123;user=******, password=******&#125;, propertyCycle -&gt; 0, testConnectionOnCheckin -&gt; false, testConnectionOnCheckout -&gt; false, unreturnedConnectionTimeout -&gt; 0, usesTraditionalReflectiveProxies -&gt; false ]</div></pre></td></tr></table></figure></p><h4 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h4><p><a href="http://blog.csdn.net/wqlpz23045/article/details/72457886" target="_blank" rel="external">可能问题</a><br><a href="https://www.ibm.com/developerworks/cn/java/j-lo-jse61/index.html#artrelatedtopics" target="_blank" rel="external">Instrumentation 新功能</a><br><a href="https://yq.aliyun.com/articles/2946?spm=5176.100239.yqblog1.45" target="_blank" rel="external">JVM源码分析之javaagent原理完全解读</a>  </p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;javaagnet为插桩提供入口，javassist实现字节码修改，这部分将记录3个demo，分别是静态agent结合javassist修改方法体，动态agent结合javassist修改方法体，最后一个demo综合使用javaagent和javassist监听c3p0数据源&lt;br&gt;
    
    </summary>
    
      <category term="java" scheme="https://yangshaoxiang.github.io/categories/java/"/>
    
    
      <category term="APM" scheme="https://yangshaoxiang.github.io/tags/APM/"/>
    
      <category term="javaagent" scheme="https://yangshaoxiang.github.io/tags/javaagent/"/>
    
  </entry>
  
  <entry>
    <title>APM(3)javassist使用</title>
    <link href="https://yangshaoxiang.github.io/2018/03/11/APM(3)javassist%E4%BD%BF%E7%94%A8/"/>
    <id>https://yangshaoxiang.github.io/2018/03/11/APM(3)javassist使用/</id>
    <published>2018-03-11T12:31:26.000Z</published>
    <updated>2018-03-13T13:03:55.929Z</updated>
    
    <content type="html"><![CDATA[<p>通过前两节，了解了javaagent相关的知识，无论静态agent还是动态agent都可以在对应用无侵入的情况下实现对应用的监控(拦截)，那么我们拦截应用的执行有什么用呢？答案是可以实现应用的监控，对类字节码的修改，动态代理等等，如果要修改类字节码则需要一个工具，这个工具就是javassist<br>Javassist是一个开源的分析、编辑和创建Java字节码的类库。其主要的优点，在于简单，而且快速。直接使用java编码的形式，而不需要了解虚拟机指令，就能动态改变类的结构，或者动态生成<br><a id="more"></a></p><h4 id="javassist使用"><a href="#javassist使用" class="headerlink" title="javassist使用"></a>javassist使用</h4><p>关于javassist直接通过代码注释方式来理解，他的主要功能是可以动态构建一个新类，或者修改已经存在的类的相关属性(成员变量，构造方法，普通方法)，使用之前先引入相关jar包<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.20.0-GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p><h4 id="动态创建类"><a href="#动态创建类" class="headerlink" title="动态创建类"></a>动态创建类</h4><p>下面是使用javassist创建一个类的实例相关api使用都已在代码中注释<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></div><div class="line"><span class="comment"> * 使用javassist动态创建一个类</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span>  <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">makeClass</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</div><div class="line">            ClassPool pool = ClassPool.getDefault();</div><div class="line">            <span class="comment">//定义类</span></div><div class="line">            CtClass stuClass = pool.makeClass(<span class="string">"com.pojo.Student"</span>);</div><div class="line"></div><div class="line">            <span class="comment">//创建成员变量--两种方式</span></div><div class="line">            <span class="comment">//id属性--通过构造方法定义</span></div><div class="line">            CtField idField = <span class="keyword">new</span> CtField(CtClass.longType, <span class="string">"id"</span>, stuClass);</div><div class="line">            idField.setModifiers(Modifier.PRIVATE);<span class="comment">//设置访问类型为私有</span></div><div class="line">            <span class="comment">//name属性--通过make方法类似写类那样定义</span></div><div class="line">            CtField nameField = CtField.make(<span class="string">"private String name;"</span>, stuClass);</div><div class="line">            stuClass.addField(idField);</div><div class="line">            stuClass.addField(nameField);</div><div class="line"></div><div class="line">            <span class="comment">//创建方法</span></div><div class="line">            CtMethod nameGetMethod = CtMethod.make(<span class="string">"public String getName()&#123;return name;&#125;"</span>, stuClass);</div><div class="line">            CtMethod nameSetMethod = CtMethod.make(<span class="string">"public void setName(String name)&#123;this.name = name;&#125;"</span>, stuClass);</div><div class="line">            stuClass.addMethod(nameGetMethod);</div><div class="line">            stuClass.addMethod(nameSetMethod);</div><div class="line"></div><div class="line">            <span class="comment">//创建构造方法</span></div><div class="line">            <span class="comment">//添加有参构造器</span></div><div class="line">            CtConstructor constructor = <span class="keyword">new</span> CtConstructor(<span class="keyword">new</span> CtClass[]&#123;CtClass.longType,pool.get(<span class="string">"java.lang.String"</span>)&#125;,stuClass);</div><div class="line">            constructor.setBody(<span class="string">"&#123;this.id=id;this.name=name;&#125;"</span>);</div><div class="line">            stuClass.addConstructor(constructor);</div><div class="line">            <span class="comment">//无参构造器</span></div><div class="line">            CtConstructor cons = <span class="keyword">new</span> CtConstructor(<span class="keyword">null</span>,stuClass);</div><div class="line">            cons.setBody(<span class="string">"&#123;&#125;"</span>);</div><div class="line">            stuClass.addConstructor(cons);</div><div class="line"></div><div class="line">            <span class="comment">//生成到文件中</span></div><div class="line">            <span class="comment">//stuClass.writeFile("C:/workproject");</span></div><div class="line"></div><div class="line">            <span class="comment">//如果要使用生成的类，可以通过如下方式加载并获取</span></div><div class="line">            <span class="comment">//输出并加载class 类，默认加载到当前线程的ClassLoader中，也可以选择输出的ClassLoader。</span></div><div class="line">            Class clazz = stuClass.toClass();</div><div class="line">            <span class="comment">// 下面是反射相关api</span></div><div class="line">            System.out.println(<span class="string">"class:"</span>+clazz.getName());</div><div class="line">            System.out.println(<span class="string">"------------属性列表------------"</span>);</div><div class="line">            Field[] fields = clazz.getDeclaredFields();</div><div class="line">            <span class="keyword">for</span> (Field field : fields) &#123;</div><div class="line">                    System.out.println(field.getType()+<span class="string">"\t"</span>+field.getName());</div><div class="line">            &#125;</div><div class="line">            System.out.println(<span class="string">"------------方法列表------------"</span>);</div><div class="line">            <span class="comment">//方法</span></div><div class="line">            Method[] methods = clazz.getDeclaredMethods();</div><div class="line">            <span class="keyword">for</span> (Method method: methods)&#123;</div><div class="line">                    System.out.println(method.getReturnType()+<span class="string">"\t"</span>+method.getName()+<span class="string">"\t"</span>+ Arrays.toString(method.getParameterTypes()));</div><div class="line">            &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p><p>若将该类生成到文件中，可以得到Student.class文件，将该文件反编译可得到如下图片结果，正是我们所创建的类</p><p><img src="http://p0zwh057c.bkt.clouddn.com/blog/180313/BlDlCcamK7.png?imageslim" alt="mark"></p><h4 id="动态修改类方法"><a href="#动态修改类方法" class="headerlink" title="动态修改类方法"></a>动态修改类方法</h4><p>用于被修改的类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Calculator</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getSum</span><span class="params">(<span class="keyword">long</span> n)</span> </span>&#123;</div><div class="line">                <span class="keyword">long</span> sum = <span class="number">0</span>;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">                        sum += i;</div><div class="line">                &#125;</div><div class="line">                System.out.println(<span class="string">"n="</span>+n+<span class="string">",sum="</span>+sum);</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>使用javassist修改类实例代码如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 使用javassist动态修改一个类</span></div><div class="line"><span class="comment">* 修改getSum的方法名为getSum$impl,并在方法体上加上一句输出</span></div><div class="line"><span class="comment">* 创建一个方法复制原来的getSum方法，并在其内调用修改后的getSum方法</span></div><div class="line"><span class="comment">* 其实这相当于在使用javassist实现动态代理，因为用户使用的仍然是getSum方法，而该方法实际上已经被我们篡改</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">modifyClass</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</div><div class="line">       ClassPool classPool = ClassPool.getDefault();</div><div class="line">       <span class="comment">//获取类</span></div><div class="line">       CtClass ctClass = classPool.get(<span class="string">"com.ssist.Calculator"</span>);</div><div class="line"></div><div class="line">       <span class="comment">// 需要修改的方法名称</span></div><div class="line">       String mname = <span class="string">"getSum"</span>;</div><div class="line">       CtMethod mold = ctClass.getDeclaredMethod(mname);</div><div class="line">       <span class="comment">// 修改原有的方法名称</span></div><div class="line">       String nname = mname + <span class="string">"$impl"</span>;</div><div class="line">       mold.setName(nname);</div><div class="line">       <span class="comment">//在方法执行前插入一条语句</span></div><div class="line">       mold.insertBefore(<span class="string">"System.out.println(\"这是插入的内容\");"</span>);</div><div class="line">       <span class="comment">//可以直接设置方法内容</span></div><div class="line">       <span class="comment">//mold.setBody("");</span></div><div class="line"></div><div class="line"></div><div class="line">       <span class="comment">//创建新的方法，复制原来的方法</span></div><div class="line">       CtMethod mnew = CtNewMethod.copy(mold, mname, ctClass, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">       <span class="comment">// 主要的注入代码</span></div><div class="line">       StringBuffer body = <span class="keyword">new</span> StringBuffer();</div><div class="line">       body.append(<span class="string">"&#123;\nlong start = System.currentTimeMillis();\n"</span>);</div><div class="line">       <span class="comment">// 调用原有代码，类似于method();($$)表示所有的参数</span></div><div class="line">       body.append(nname + <span class="string">"($$);\n"</span>);</div><div class="line">       body.append(<span class="string">"System.out.println(\"Call to method "</span> + mname</div><div class="line">               + <span class="string">" took \" +\n (System.currentTimeMillis()-start) + "</span> + <span class="string">"\" ms.\");\n"</span>);</div><div class="line">       body.append(<span class="string">"&#125;"</span>);</div><div class="line"></div><div class="line">       <span class="comment">// 替换新方法</span></div><div class="line">       mnew.setBody(body.toString());</div><div class="line">       <span class="comment">// 增加新方法</span></div><div class="line">       ctClass.addMethod(mnew);</div><div class="line"></div><div class="line">       <span class="comment">//执行修改后的getSum方法--此时该方法名称已改为getSum$Impl</span></div><div class="line">       System.out.println(<span class="string">"-----这是在执行原来的getSum方法，修改后是getSum$Impl方法-------"</span>);</div><div class="line">       Calculator calculator =(Calculator)ctClass.toClass().newInstance();</div><div class="line">       Class  clazz = Calculator.class;</div><div class="line">       Method declaredMethod = clazz.getDeclaredMethod(nname, <span class="keyword">long</span>.class);</div><div class="line">       declaredMethod.invoke(calculator,<span class="number">10000</span>);</div><div class="line"></div><div class="line">       <span class="comment">//执行新添加的方法getSum，该方法为复制原来的getSum方法，并修改了部分方法体内容</span></div><div class="line">       System.out.println(<span class="string">"-----这是在执行新添加的getSum方法(原来的getSum已经改名)-----"</span>);</div><div class="line">       calculator.getSum(<span class="number">10000</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h4 id="javassist执行流程图和UML类图"><a href="#javassist执行流程图和UML类图" class="headerlink" title="javassist执行流程图和UML类图"></a>javassist执行流程图和UML类图</h4><p>执行流程图:<br><img src="http://p0zwh057c.bkt.clouddn.com/blog/180313/Kc6bEAc6fa.png?imageslim" alt="mark"><br>类图:<br><img src="http://p0zwh057c.bkt.clouddn.com/blog/180313/JgL0he3Hj9.png?imageslim" alt="mark"></p><h4 id="javassist特殊符号说明及注意点"><a href="#javassist特殊符号说明及注意点" class="headerlink" title="javassist特殊符号说明及注意点"></a>javassist特殊符号说明及注意点</h4><p><img src="http://p0zwh057c.bkt.clouddn.com/blog/180313/16AjKld6mf.png?imageslim" alt="mark"><br>注意点:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">javassist 特殊语法说明：</div><div class="line">a) 不能引用在方法中其它地方定义的局部变量</div><div class="line">b) 不会对类型进行强制检查：如 int start = System.currentTimeMillis(); 或 String i=”abc”;</div></pre></td></tr></table></figure></p><h4 id="参考博客"><a href="#参考博客" class="headerlink" title="参考博客"></a>参考博客</h4><p><a href="https://www.cnblogs.com/sunfie/p/5154246.html" target="_blank" rel="external">Java学习之javassist</a><br><a href="http://blog.csdn.net/top_code/article/details/51708043" target="_blank" rel="external">Java动态编程之javassist</a><br>鲁班大师pdf文档</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;通过前两节，了解了javaagent相关的知识，无论静态agent还是动态agent都可以在对应用无侵入的情况下实现对应用的监控(拦截)，那么我们拦截应用的执行有什么用呢？答案是可以实现应用的监控，对类字节码的修改，动态代理等等，如果要修改类字节码则需要一个工具，这个工具就是javassist&lt;br&gt;Javassist是一个开源的分析、编辑和创建Java字节码的类库。其主要的优点，在于简单，而且快速。直接使用java编码的形式，而不需要了解虚拟机指令，就能动态改变类的结构，或者动态生成&lt;br&gt;
    
    </summary>
    
      <category term="java" scheme="https://yangshaoxiang.github.io/categories/java/"/>
    
    
      <category term="APM" scheme="https://yangshaoxiang.github.io/tags/APM/"/>
    
      <category term="javaagent" scheme="https://yangshaoxiang.github.io/tags/javaagent/"/>
    
  </entry>
  
  <entry>
    <title>APM(2)动态javaagent使用</title>
    <link href="https://yangshaoxiang.github.io/2018/03/09/APM(2)%E5%8A%A8%E6%80%81javaagent%E4%BD%BF%E7%94%A8/"/>
    <id>https://yangshaoxiang.github.io/2018/03/09/APM(2)动态javaagent使用/</id>
    <published>2018-03-09T12:31:26.000Z</published>
    <updated>2018-03-13T13:28:01.838Z</updated>
    
    <content type="html"><![CDATA[<p>通过 <a href="https://yangshaoxiang.github.io/2018/03/07/APM(1)%E9%9D%99%E6%80%81javaagent%E4%BD%BF%E7%94%A8/#more">上一篇博客</a> 可以知道静态javaagent的使用必须在启动项目时加上javagent的相关启动参数，并且premain()方法也总是在main()方法之前执行，因此有一一定的局限性，在java6之后则做出了改变，有另一种方式可以在main方法启动之后执行，而且不需要添加jvm的启动参数<br><a id="more"></a></p><h4 id="动态javaagent使用步骤"><a href="#动态javaagent使用步骤" class="headerlink" title="动态javaagent使用步骤"></a>动态javaagent使用步骤</h4><ol><li><p>任意编写一个类，类中有如下两个方法之一即可(若两个都有，多参的优先级高)</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">agentmain</span><span class="params">(String arg, Instrumentation instrumentation)</span></span>&#123;&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">agentmain</span><span class="params">(String arg)</span></span>&#123;&#125;</div></pre></td></tr></table></figure><p> 示例代码:  </p> <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">agentmain</span><span class="params">(String args, Instrumentation agentmain)</span> </span>&#123;</div><div class="line">    System.out.println(String.format(<span class="string">"系统载入agentmain 参数%s 载入方法:premain"</span>, args));</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>动态的agent相对于静态agent需要添加两个依赖，构建打包时在pom文件中加入如下配置，让该类在打包成jar包时他的MANIFEST.MF文件中有代表该类为Agent类的信息</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line"> <span class="comment">&lt;!-- 使用atch时要引入--&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.tl.viptest<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jconsole<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">scope</span>&gt;</span>system<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">systemPath</span>&gt;</span>$&#123;java.home&#125;/../lib/jconsole.jar<span class="tag">&lt;/<span class="name">systemPath</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.tl.viptest<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">scope</span>&gt;</span>system<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">systemPath</span>&gt;</span>$&#123;java.home&#125;/../lib/tools.jar<span class="tag">&lt;/<span class="name">systemPath</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                  <span class="tag">&lt;<span class="name">archive</span>&gt;</span></div><div class="line">                      <span class="tag">&lt;<span class="name">manifestEntries</span>&gt;</span></div><div class="line">                          <span class="tag">&lt;<span class="name">Project-name</span>&gt;</span>$&#123;project.name&#125;<span class="tag">&lt;/<span class="name">Project-name</span>&gt;</span></div><div class="line">                          <span class="tag">&lt;<span class="name">Project-version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">Project-version</span>&gt;</span></div><div class="line">                          <span class="tag">&lt;<span class="name">Boot-Class-Path</span>&gt;</span>javassist-3.18.1-GA.jar<span class="tag">&lt;/<span class="name">Boot-Class-Path</span>&gt;</span></div><div class="line">                          <span class="tag">&lt;<span class="name">Agent-Class</span>&gt;</span>上面编写的agent类全路径<span class="tag">&lt;/<span class="name">Agent-Class</span>&gt;</span></div><div class="line">                          <span class="tag">&lt;<span class="name">Can-Redefine-Classes</span>&gt;</span>true<span class="tag">&lt;/<span class="name">Can-Redefine-Classes</span>&gt;</span></div><div class="line">                      <span class="tag">&lt;/<span class="name">manifestEntries</span>&gt;</span></div><div class="line">                  <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></div><div class="line">                  <span class="tag">&lt;<span class="name">skip</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skip</span>&gt;</span></div><div class="line">              <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div></pre></td></tr></table></figure><p> 在<agent-class>标签下加上Agent类的全路径，完成后将该类所在的项目打成jar包<br> 参数含义:  </agent-class></p> <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#动态agent 类</div><div class="line">Agent-Class: com.agenttest.DynamicAgent</div><div class="line">#agent 依懒包逗号分割</div><div class="line">Boot-Class-Path: javassist-<span class="number">3.18</span>.1-GA.jar</div><div class="line">#是否允许重复装载</div><div class="line">Can-Redefine-Classes: <span class="keyword">true</span></div></pre></td></tr></table></figure></li><li><p>测试<br> 执行main方法获取当前运行的jvm的进程id，之后睡眠当前线程，将获取到的进程id填入agentAttach()的局部变量targetPid，之后执行agentAttach()方法  </p> <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.sun.tools.attach.VirtualMachine;</div><div class="line"><span class="keyword">import</span> org.junit.Ignore;</div><div class="line"><span class="keyword">import</span> org.junit.Test;</div><div class="line"><span class="keyword">import</span> java.lang.management.ManagementFactory;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAgentTest</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        System.out.println(<span class="string">"输出进程ID："</span>+ ManagementFactory.getRuntimeMXBean().getName());</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            Thread.sleep(<span class="number">100</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Ignore</span></div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">agentAttach</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        String targetPid = <span class="string">"16004"</span>;<span class="comment">//这里输入main方法获取到的进程id</span></div><div class="line">        VirtualMachine vm = VirtualMachine.attach(targetPid);</div><div class="line">        vm.loadAgent(<span class="string">"jar包所在磁盘路径"</span>, <span class="string">"传入的参数"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p> 输出结果如下:  </p><p> <img src="http://p0zwh057c.bkt.clouddn.com/blog/180312/GIC7J7DLaj.png?imageslim" alt="mark"></p><p> 结论:  动态agent可以在main方法启动后执行，并且启动的main方法不需要加任何的jvm启动参数</p></li></ol><h4 id="流程总结及与静态agent对比"><a href="#流程总结及与静态agent对比" class="headerlink" title="流程总结及与静态agent对比"></a>流程总结及与静态agent对比</h4><pre><code>1. 静态动态agent都是首先任意编写一个agent类，区别是静态agent类中必须要有premain()方法，动态agent类中必须要有agentmain()方法2. 将该类打成jar包，静态agent的jar中MANIFEST.MF必须要有Premain-Class，对于动态agent的jar中MANIFEST.MF必须要有Agent-Class3. 运行时静态agent的premain方法会在main方法之前执行，并且执行main方法是必须添加对应的jvm启动参数，动态agent的agentmain方法在main方法启动后才会执行,并且无需main方法所在类添加jvm启动参数</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;通过 &lt;a href=&quot;https://yangshaoxiang.github.io/2018/03/07/APM(1)%E9%9D%99%E6%80%81javaagent%E4%BD%BF%E7%94%A8/#more&quot;&gt;上一篇博客&lt;/a&gt; 可以知道静态javaagent的使用必须在启动项目时加上javagent的相关启动参数，并且premain()方法也总是在main()方法之前执行，因此有一一定的局限性，在java6之后则做出了改变，有另一种方式可以在main方法启动之后执行，而且不需要添加jvm的启动参数&lt;br&gt;
    
    </summary>
    
      <category term="java" scheme="https://yangshaoxiang.github.io/categories/java/"/>
    
    
      <category term="APM" scheme="https://yangshaoxiang.github.io/tags/APM/"/>
    
      <category term="javaagent" scheme="https://yangshaoxiang.github.io/tags/javaagent/"/>
    
  </entry>
  
  <entry>
    <title>APM(1)静态javaagent使用</title>
    <link href="https://yangshaoxiang.github.io/2018/03/07/APM(1)%E9%9D%99%E6%80%81javaagent%E4%BD%BF%E7%94%A8/"/>
    <id>https://yangshaoxiang.github.io/2018/03/07/APM(1)静态javaagent使用/</id>
    <published>2018-03-07T12:31:26.000Z</published>
    <updated>2018-03-13T12:33:12.389Z</updated>
    
    <content type="html"><![CDATA[<p>javaagent是java5的新特性，依赖他我们可以构建一个独立于应用程序的代理程序（Agent），用来监测和协助运行在 JVM 上的程序，甚至能够替换和修改某些类的定义，过程上简单来说就是编写一个特殊的类将其打成jar包，要监控(拦截)的项目在启动时jvm参数加上特殊的启动命令，即可监控该项目<br><a id="more"></a></p><h4 id="javaagent使用步骤"><a href="#javaagent使用步骤" class="headerlink" title="javaagent使用步骤"></a>javaagent使用步骤</h4><ol><li><p>任意编写一个类，类中有如下两个方法之一即可</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">/**</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> arg agentArgs 是 premain 函数得到的程序参数，随同 “– javaagent”一起传入。</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> instrumentation instrumentation 是一个 java.lang.instrument.Instrumentation 的实例，由 JVM 自动传入</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String arg, Instrumentation instrumentation)</span></span>&#123;&#125;</div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String arg)</span></span>&#123;&#125;</div></pre></td></tr></table></figure><p> 示例代码:</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.agenttest;</div><div class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FirstAgent</span> </span>&#123;</div><div class="line">    <span class="comment">//静态装载agent</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String arg, Instrumentation instrumentation)</span></span>&#123;</div><div class="line">        System.out.println(<span class="string">"这里执行了premain()方法，进行了装载"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>在pom文件中加入如下配置，让该类在打包成jar包时他的MANIFEST.MF文件中有代表该类为Agent类的信息</p> <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                 <span class="tag">&lt;<span class="name">archive</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">manifestEntries</span>&gt;</span></div><div class="line">                         <span class="tag">&lt;<span class="name">Project-name</span>&gt;</span>$&#123;project.name&#125;<span class="tag">&lt;/<span class="name">Project-name</span>&gt;</span></div><div class="line">                         <span class="tag">&lt;<span class="name">Project-version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">Project-version</span>&gt;</span></div><div class="line">                         <span class="tag">&lt;<span class="name">Premain-Class</span>&gt;</span>com.agenttest.FirstAgent<span class="tag">&lt;/<span class="name">Premain-Class</span>&gt;</span></div><div class="line">                        <span class="comment">&lt;!-- &lt;Boot-Class-Path&gt;javassist-3.18.1-GA.jar&lt;/Boot-Class-Path&gt;</span></div><div class="line"><span class="comment">                         &lt;Agent-Class&gt;com.agenttest.DynamicAgent&lt;/Agent-Class&gt;</span></div><div class="line"><span class="comment">                         &lt;Can-Redefine-Classes&gt;true&lt;/Can-Redefine-Classes&gt;--&gt;</span></div><div class="line">                     <span class="tag">&lt;/<span class="name">manifestEntries</span>&gt;</span></div><div class="line">                 <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></div><div class="line">                 <span class="tag">&lt;<span class="name">skip</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skip</span>&gt;</span></div><div class="line">             <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">         <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div></pre></td></tr></table></figure><p> 在<premain-class>标签下加上Agent类的全路径，完成后将该类所在的项目打成jar包<br> 参数含义:  </premain-class></p> <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">#动态agent 类</div><div class="line">Agent-Class: com.agenttest.DynamicAgent</div><div class="line">#agent 依懒包逗号分割</div><div class="line">Boot-Class-Path: javassist-<span class="number">3.18</span>.1-GA.jar</div><div class="line">#是否允许重复装载</div><div class="line">Can-Redefine-Classes: <span class="keyword">true</span></div><div class="line">#静agent 类</div><div class="line">Premain-Class: com.agenttest.FirstAgent</div></pre></td></tr></table></figure></li><li><p>在运行要被”拦截”的项目时，添加一个jvm的启动参数<br><code>-javaagent:xxx.jar(=parama=aaa)</code>：xxx是jar包的路径,后面可以接着跟参数<br><img src="http://p0zwh057c.bkt.clouddn.com/blog/180308/9bjHD4LDiJ.png?imageslim" alt="mark">测试类中示例代码:</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FirstAgentTest</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">            System.out.println(<span class="string">"main方法中的输出"</span>);</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>运行结果<br> 会先执行premain中的方法，在执行main方法</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">这里执行了premain()方法，进行了装载</div><div class="line">main方法中的输出</div></pre></td></tr></table></figure></li></ol><h4 id="javaagent的jar和普通jar区别"><a href="#javaagent的jar和普通jar区别" class="headerlink" title="javaagent的jar和普通jar区别"></a>javaagent的jar和普通jar区别</h4><p> <img src="http://p0zwh057c.bkt.clouddn.com/blog/180308/H5De9120bI.png?imageslim" alt="mark"></p><h4 id="javaagent-底层流程"><a href="#javaagent-底层流程" class="headerlink" title="javaagent 底层流程"></a>javaagent 底层流程</h4><p>javaagent 装载时序图（premain）：</p><p><img src="http://p0zwh057c.bkt.clouddn.com/blog/180308/L39b2Eiegf.png?imageslim" alt="mark"></p><p>Class 装载时序图</p><p><img src="http://p0zwh057c.bkt.clouddn.com/blog/180308/DG84aabfmD.png?imageslim" alt="mark"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;javaagent是java5的新特性，依赖他我们可以构建一个独立于应用程序的代理程序（Agent），用来监测和协助运行在 JVM 上的程序，甚至能够替换和修改某些类的定义，过程上简单来说就是编写一个特殊的类将其打成jar包，要监控(拦截)的项目在启动时jvm参数加上特殊的启动命令，即可监控该项目&lt;br&gt;
    
    </summary>
    
      <category term="java" scheme="https://yangshaoxiang.github.io/categories/java/"/>
    
    
      <category term="APM" scheme="https://yangshaoxiang.github.io/tags/APM/"/>
    
      <category term="javaagent" scheme="https://yangshaoxiang.github.io/tags/javaagent/"/>
    
  </entry>
  
  <entry>
    <title>linux下JavaWeb开发环境搭建</title>
    <link href="https://yangshaoxiang.github.io/2017/12/24/linux%E4%B8%8BJavaWeb%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
    <id>https://yangshaoxiang.github.io/2017/12/24/linux下JavaWeb开发环境搭建/</id>
    <published>2017-12-24T15:20:21.000Z</published>
    <updated>2017-12-24T15:56:57.386Z</updated>
    
    <content type="html"><![CDATA[<h3 id="web开发基本环境安装配置"><a href="#web开发基本环境安装配置" class="headerlink" title="web开发基本环境安装配置"></a>web开发基本环境安装配置</h3><p>  JavaWeb开发中生产环境一般都为linux，因此我们要具有在linux环境下搭建基本的JavaWeb开发常用环境的能力，本篇博客介绍的是linux环境下jdk的安装，tomcat的安装，及mysql数据库的安装<br><a id="more"></a></p><h4 id="jdk的安装"><a href="#jdk的安装" class="headerlink" title="jdk的安装"></a>jdk的安装</h4><ol><li>到<a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html" target="_blank" rel="external">oracle官网下载</a>linux版本jdk安装包上传到/root目录下</li><li><p>解压，指定存放位置</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#解压jdk文件:  </span></div><div class="line">tar zxvf jdk-7u79-linux-x64.gz</div><div class="line"><span class="comment">#创建jdk的实际安装目录</span></div><div class="line">mkdir  /usr/<span class="built_in">local</span>/java</div><div class="line"><span class="comment">#将解压后的文件复制到安装目录中</span></div><div class="line">mv ./jdk1.7.0_79/ /usr/<span class="built_in">local</span>/java</div><div class="line"><span class="comment">#配置环境变量</span></div><div class="line">vi /etc/profile</div></pre></td></tr></table></figure></li><li><p>配置环境变量(注意要与自己的目录匹配)<br> 在profile文件中追加如下内容:</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">JAVA_HOME=/usr/local/java/jdk1.7.0_79</div><div class="line">PATH=$PATH:$JAVA_HOME/bin</div><div class="line">CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</div><div class="line"></div><div class="line">export JAVA_HOME</div><div class="line">export PATH</div><div class="line">export CLASSPATH</div></pre></td></tr></table></figure><p> 执行如下命令使环境变量生效:</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">source</span> /etc/profile</div></pre></td></tr></table></figure></li><li><p>测试是否成功</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">java</div><div class="line">javac</div><div class="line">java -version</div></pre></td></tr></table></figure></li></ol><h4 id="tomcat的安装"><a href="#tomcat的安装" class="headerlink" title="tomcat的安装"></a>tomcat的安装</h4><ol><li>将tomcat安装包上传到linux中</li><li><p>解压，转移</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 解压</span></div><div class="line">tar zfvx apache-tomcat-7.0.68.tar.gz</div><div class="line"><span class="comment"># 移动</span></div><div class="line">mv ./apache-tomcat-7.0.68 /usr/<span class="built_in">local</span>/tomcat</div><div class="line"><span class="comment">#启动</span></div><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/tomcat/bin</div><div class="line"> ./startup.sh</div></pre></td></tr></table></figure></li><li><p>添加防火墙端口(8080)</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">vi  /etc/sysconfig/iptables</div><div class="line"><span class="comment"># 在打开的文件中加入如下内容</span></div><div class="line">-A INPUT -p tcp -m state --state NEW -m tcp --dport 8080 -j ACCEPT</div></pre></td></tr></table></figure></li><li><p>测试，访问<br>浏览器访问 <a href="http://ip_or__domain:8080/" target="_blank" rel="external">http://ip_or__domain:8080/</a></p></li></ol><h4 id="mysql的安装"><a href="#mysql的安装" class="headerlink" title="mysql的安装"></a>mysql的安装</h4><h5 id="下载与安装"><a href="#下载与安装" class="headerlink" title="下载与安装"></a>下载与安装</h5><ol><li><p><a href="https://dev.mysql.com/downloads/mysql/5.6.html#downloads" title="点击进入下载页" target="_blank" rel="external">下载mysql</a>的源码包，选项如下图所示:<br><img src="http://p0zwh057c.bkt.clouddn.com/blog/171218/K0ffI1dJ7H.png?imageslim" alt="mark">  </p></li><li><p>制作安装脚本<br>新建一个名称为mysql_install_offline.sh的文本文件，将下面的文本内容复制到新建的文本中,要注意文本中mysql_6_version是你下载的源码包的版本,dbrootpwd代表数据库密码</p>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div></pre></td><td class="code"><pre><div class="line"><span class="meta"> #</span><span class="bash">!/bin/bash</span></div><div class="line"></div><div class="line">yum install bison cmake gcc make ncurses perl wget</div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> Notes: install mysql5.6 on centos</span></div><div class="line"><span class="meta">#</span><span class="bash"></span></div><div class="line">mysql_install_dir=/usr/mysql</div><div class="line">mysql_data_dir=/data/mysql</div><div class="line">mysql_6_version=5.6.38</div><div class="line">dbrootpwd=123456</div><div class="line"></div><div class="line">Mem=`free -m | awk '/Mem:/&#123;print $2&#125;'`</div><div class="line">Swap=`free -m | awk '/Swap:/&#123;print $2&#125;'`</div><div class="line"></div><div class="line">Install_MySQL-5-6()</div><div class="line">&#123;</div><div class="line">yum -y install make gcc-c++ cmake bison-devel  ncurses-devel</div><div class="line"><span class="meta">#</span><span class="bash">wget http://mirrors.sohu.com/mysql/MySQL-5.6/mysql-<span class="variable">$&#123;mysql_6_version&#125;</span>.tar.gz</span></div><div class="line"></div><div class="line">id -u mysql &gt;/dev/null 2&gt;&amp;1</div><div class="line">[ $? -ne 0 ] &amp;&amp; useradd -M -s /sbin/nologin mysql</div><div class="line"></div><div class="line">mkdir -p $mysql_data_dir;chown mysql.mysql -R $mysql_data_dir</div><div class="line">tar zxf mysql-$&#123;mysql_6_version&#125;.tar.gz</div><div class="line">cd mysql-$mysql_6_version</div><div class="line">make clean</div><div class="line">[ ! -d "$mysql_install_dir" ] &amp;&amp; mkdir -p $mysql_install_dir</div><div class="line">cmake . -DCMAKE_INSTALL_PREFIX=$mysql_install_dir \</div><div class="line">-DMYSQL_DATADIR=$mysql_data_dir \</div><div class="line">-DSYSCONFDIR=/etc \</div><div class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</div><div class="line">-DWITH_PARTITION_STORAGE_ENGINE=1 \</div><div class="line">-DWITH_FEDERATED_STORAGE_ENGINE=1 \</div><div class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \</div><div class="line">-DWITH_MYISAM_STORAGE_ENGINE=1 \</div><div class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</div><div class="line">-DENABLED_LOCAL_INFILE=1 \</div><div class="line">-DENABLE_DTRACE=0 \</div><div class="line">-DEXTRA_CHARSETS=all \</div><div class="line">-DDEFAULT_CHARSET=utf8mb4 \</div><div class="line">-DDEFAULT_COLLATION=utf8mb4_general_ci \</div><div class="line">-DWITH_EMBEDDED_SERVER=1 \</div><div class="line"></div><div class="line">make -j `grep processor /proc/cpuinfo | wc -l`</div><div class="line">make install</div><div class="line"></div><div class="line">if [ -d "$mysql_install_dir/support-files" ];then</div><div class="line">    echo "$&#123;CSUCCESS&#125;MySQL install successfully! $&#123;CEND&#125;"</div><div class="line">    cd ..</div><div class="line">    rm -rf mysql-$mysql_6_version</div><div class="line">else</div><div class="line">    rm -rf $mysql_install_dir</div><div class="line">    echo "$&#123;CFAILURE&#125;MySQL install failed, Please contact the author! $&#123;CEND&#125;"</div><div class="line">    kill -9 $$</div><div class="line">fi</div><div class="line"></div><div class="line">/bin/cp $mysql_install_dir/support-files/mysql.server /etc/init.d/mysqld</div><div class="line">chmod +x /etc/init.d/mysqld</div><div class="line">chkconfig mysqld on</div><div class="line">cd ..</div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> my.cf</span></div><div class="line">[ -d "/etc/mysql" ] &amp;&amp; /bin/mv /etc/mysql&#123;,_bk&#125;</div><div class="line">cat &gt; /etc/my.cnf &lt;&lt; EOF</div><div class="line">[client]</div><div class="line">port = 3306</div><div class="line">socket = /tmp/mysql.sock</div><div class="line">default-character-set = utf8mb4</div><div class="line"></div><div class="line">[mysqld]</div><div class="line">port = 3306</div><div class="line">socket = /tmp/mysql.sock</div><div class="line"></div><div class="line">basedir = $mysql_install_dir</div><div class="line">datadir = $mysql_data_dir</div><div class="line">pid-file = $mysql_data_dir/mysql.pid</div><div class="line">user = mysql</div><div class="line">bind-address = 0.0.0.0</div><div class="line">server-id = 1</div><div class="line"></div><div class="line">init-connect = 'SET NAMES utf8mb4'</div><div class="line">character-set-server = utf8mb4</div><div class="line"></div><div class="line">skip-name-resolve</div><div class="line">skip-external-locking</div><div class="line"><span class="meta">#</span><span class="bash">skip-networking</span></div><div class="line">back_log = 300</div><div class="line"></div><div class="line">max_connections = 1000</div><div class="line">max_connect_errors = 6000</div><div class="line">open_files_limit = 65535</div><div class="line">table_open_cache = 128</div><div class="line">max_allowed_packet = 4M</div><div class="line">binlog_cache_size = 1M</div><div class="line">max_heap_table_size = 8M</div><div class="line">tmp_table_size = 16M</div><div class="line"></div><div class="line">read_buffer_size = 2M</div><div class="line">read_rnd_buffer_size = 8M</div><div class="line">sort_buffer_size = 8M</div><div class="line">join_buffer_size = 8M</div><div class="line">key_buffer_size = 4M</div><div class="line">thread_cache_size = 8</div><div class="line">query_cache_type = 1</div><div class="line">query_cache_size = 8M</div><div class="line">query_cache_limit = 2M</div><div class="line">ft_min_word_len = 4</div><div class="line">log_bin = mysql-bin</div><div class="line">binlog_format = mixed</div><div class="line">expire_logs_days = 10</div><div class="line">log_error = $mysql_data_dir/mysql-error.log</div><div class="line">slow_query_log = 1</div><div class="line">long_query_time = 1</div><div class="line"><span class="meta">#</span><span class="bash">slow_query_log_file = <span class="variable">$mysql_data_dir</span>/mysql-slow.log</span></div><div class="line">performance_schema = 0</div><div class="line">explicit_defaults_for_timestamp</div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash">lower_case_table_names = 1</span></div><div class="line">default_storage_engine = InnoDB</div><div class="line"><span class="meta">#</span><span class="bash">default-storage-engine = MyISAM</span></div><div class="line">innodb_file_per_table = 1</div><div class="line">innodb_open_files = 500</div><div class="line">innodb_buffer_pool_size = 64M</div><div class="line">innodb_write_io_threads = 4</div><div class="line">innodb_read_io_threads = 4</div><div class="line">innodb_thread_concurrency = 0</div><div class="line">innodb_purge_threads = 1</div><div class="line">innodb_flush_log_at_trx_commit = 2</div><div class="line">innodb_log_buffer_size = 2M</div><div class="line">innodb_log_file_size = 32M</div><div class="line">innodb_log_files_in_group = 3</div><div class="line">innodb_max_dirty_pages_pct = 90</div><div class="line">innodb_lock_wait_timeout = 120</div><div class="line"></div><div class="line">bulk_insert_buffer_size = 8M</div><div class="line">myisam_sort_buffer_size = 8M</div><div class="line">myisam_max_sort_file_size = 10G</div><div class="line">myisam_repair_threads = 1</div><div class="line"></div><div class="line">interactive_timeout = 28800</div><div class="line">wait_timeout = 28800</div><div class="line"></div><div class="line">[mysqldump]</div><div class="line">quick</div><div class="line">max_allowed_packet = 16M</div><div class="line"></div><div class="line">[myisamchk]</div><div class="line">key_buffer_size = 8M</div><div class="line">sort_buffer_size = 8M</div><div class="line">read_buffer = 4M</div><div class="line">write_buffer = 4M</div><div class="line"></div><div class="line">EOF</div><div class="line"></div><div class="line">if [ $Mem -gt 1500 -a $Mem -le 2500 ];then</div><div class="line">    sed -i 's@^thread_cache_size.*@thread_cache_size = 16@' /etc/my.cnf</div><div class="line">    sed -i 's@^query_cache_size.*@query_cache_size = 16M@' /etc/my.cnf</div><div class="line">    sed -i 's@^myisam_sort_buffer_size.*@myisam_sort_buffer_size = 16M@' /etc/my.cnf</div><div class="line">    sed -i 's@^key_buffer_size.*@key_buffer_size = 16M@' /etc/my.cnf</div><div class="line">    sed -i 's@^innodb_buffer_pool_size.*@innodb_buffer_pool_size = 128M@' /etc/my.cnf</div><div class="line">    sed -i 's@^tmp_table_size.*@tmp_table_size = 32M@' /etc/my.cnf</div><div class="line">    sed -i 's@^table_open_cache.*@table_open_cache = 256@' /etc/my.cnf</div><div class="line">elif [ $Mem -gt 2500 -a $Mem -le 3500 ];then</div><div class="line">    sed -i 's@^thread_cache_size.*@thread_cache_size = 32@' /etc/my.cnf</div><div class="line">    sed -i 's@^query_cache_size.*@query_cache_size = 32M@' /etc/my.cnf</div><div class="line">    sed -i 's@^myisam_sort_buffer_size.*@myisam_sort_buffer_size = 32M@' /etc/my.cnf</div><div class="line">    sed -i 's@^key_buffer_size.*@key_buffer_size = 64M@' /etc/my.cnf</div><div class="line">    sed -i 's@^innodb_buffer_pool_size.*@innodb_buffer_pool_size = 512M@' /etc/my.cnf</div><div class="line">    sed -i 's@^tmp_table_size.*@tmp_table_size = 64M@' /etc/my.cnf</div><div class="line">    sed -i 's@^table_open_cache.*@table_open_cache = 512@' /etc/my.cnf</div><div class="line">elif [ $Mem -gt 3500 ];then</div><div class="line">    sed -i 's@^thread_cache_size.*@thread_cache_size = 64@' /etc/my.cnf</div><div class="line">    sed -i 's@^query_cache_size.*@query_cache_size = 64M@' /etc/my.cnf</div><div class="line">    sed -i 's@^myisam_sort_buffer_size.*@myisam_sort_buffer_size = 64M@' /etc/my.cnf</div><div class="line">    sed -i 's@^key_buffer_size.*@key_buffer_size = 256M@' /etc/my.cnf</div><div class="line">    sed -i 's@^innodb_buffer_pool_size.*@innodb_buffer_pool_size = 1024M@' /etc/my.cnf</div><div class="line">    sed -i 's@^tmp_table_size.*@tmp_table_size = 128M@' /etc/my.cnf</div><div class="line">    sed -i 's@^table_open_cache.*@table_open_cache = 1024@' /etc/my.cnf</div><div class="line">fi</div><div class="line"></div><div class="line"><span class="meta">$</span><span class="bash">mysql_install_dir/scripts/mysql_install_db --user=mysql --basedir=<span class="variable">$mysql_install_dir</span> --datadir=<span class="variable">$mysql_data_dir</span></span></div><div class="line"></div><div class="line">chown mysql.mysql -R $mysql_data_dir</div><div class="line">service mysqld start</div><div class="line">[ -z "`grep ^'export PATH=' /etc/profile`" ] &amp;&amp; echo "export PATH=$mysql_install_dir/bin:\$PATH" &gt;&gt; /etc/profile</div><div class="line">[ -n "`grep ^'export PATH=' /etc/profile`" -a -z "`grep $mysql_install_dir /etc/profile`" ] &amp;&amp; sed -i "s@^export PATH=\(.*\)@export PATH=$mysql_install_dir/bin:\1@" /etc/profile</div><div class="line"></div><div class="line">. /etc/profile</div><div class="line"></div><div class="line"><span class="meta">$</span><span class="bash">mysql_install_dir/bin/mysql -e <span class="string">"grant all privileges on *.* to root@'127.0.0.1' identified by \"<span class="variable">$dbrootpwd</span>\" with grant option;"</span></span></div><div class="line"><span class="meta">$</span><span class="bash">mysql_install_dir/bin/mysql -e <span class="string">"grant all privileges on *.* to root@'localhost' identified by \"<span class="variable">$dbrootpwd</span>\" with grant option;"</span></span></div><div class="line"><span class="meta">$</span><span class="bash">mysql_install_dir/bin/mysql -uroot -p<span class="variable">$dbrootpwd</span> -e <span class="string">"delete from mysql.user where Password='';"</span></span></div><div class="line"><span class="meta">$</span><span class="bash">mysql_install_dir/bin/mysql -uroot -p<span class="variable">$dbrootpwd</span> -e <span class="string">"delete from mysql.db where User='';"</span></span></div><div class="line"><span class="meta">$</span><span class="bash">mysql_install_dir/bin/mysql -uroot -p<span class="variable">$dbrootpwd</span> -e <span class="string">"delete from mysql.proxies_priv where Host!='localhost';"</span></span></div><div class="line"><span class="meta">$</span><span class="bash">mysql_install_dir/bin/mysql -uroot -p<span class="variable">$dbrootpwd</span> -e <span class="string">"drop database test;"</span></span></div><div class="line"><span class="meta">$</span><span class="bash">mysql_install_dir/bin/mysql -uroot -p<span class="variable">$dbrootpwd</span> -e <span class="string">"reset master;"</span></span></div><div class="line">rm -rf /etc/ld.so.conf.d/&#123;mysql,mariadb,percona&#125;*.conf</div><div class="line">echo "$mysql_install_dir/lib" &gt; mysql.conf</div><div class="line">/sbin/ldconfig</div><div class="line">service mysqld stop</div><div class="line">&#125;</div><div class="line">Install_MySQL-5-6</div></pre></td></tr></table></figure></li><li><p>将源码包及及脚本上传到linux中<br>例如我这里将两个文件上传到了/root中，关于如何上传，查看<a href="https://yangshaoxiang.github.io/2017/12/09/linux%E4%B8%8B%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD/#more">上一篇博客</a></p></li><li><p>执行脚本安装mysql</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /root</div><div class="line"><span class="comment">#使脚本具有可执行的权限</span></div><div class="line">chmod +x mysql_install_offline.sh</div><div class="line"><span class="comment">#执行之前安装autoconf库，此包安装时会安装Data:Dumper模块</span></div><div class="line">yum -y install autoconf</div><div class="line"><span class="comment">#执行安装脚本</span></div><div class="line">./mysql_install_offline.sh</div></pre></td></tr></table></figure></li><li><p>添加mysql端口号(3306)到防火墙中</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">vi  /etc/sysconfig/iptables</div><div class="line"><span class="comment"># 在打开的文件中加入如下内容</span></div><div class="line">-A INPUT -p tcp -m state --state NEW -m tcp --dport 3306 -j ACCEPT</div></pre></td></tr></table></figure></li></ol><h5 id="配置外网Navicat可访问"><a href="#配置外网Navicat可访问" class="headerlink" title="配置外网Navicat可访问"></a>配置外网Navicat可访问</h5><p>  如果按照以上步骤安装完成后，本地的Navicat无法连接，参考以下步骤</p><ol><li><p>确认开启mysql数据库的服务(解决连接报10038)<br> 在终端下输入：</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/etc/rc.d/init.d/mysqld status</div></pre></td></tr></table></figure><p>   查看MySQL状态，看看是否运行，若没有运行的话就输入如下命令初始化数据库：</p>   <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/etc/rc.d/init.d/mysqld start</div></pre></td></tr></table></figure></li><li><p>无法使用数据库命令<br><code>mysql -u root -p</code> 此项报错 <code>-bash: mysql: command not found</code><br>这是类似于windows中的环境变量没有配置，执行linux命令默认会去/usr/local/bin下去找所以配置一个映射，操作步骤如下:</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/bin</div><div class="line">ln -fs /usr/<span class="built_in">local</span>/mysql/bin/mysql</div><div class="line"><span class="comment">#如果报usr/bin/mysql不存在，切换到usr/bin执行如下命令</span></div><div class="line">ln -fs /usr/mysql/bin/mysql</div></pre></td></tr></table></figure></li><li><p>解决连接报1130<br>ERROR 1130: Host xxx.xxx.xxx.xxx  is not allowed to connect to this MySQL server<br>猜想是无法给远程连接的用户权限问题，按如下方式操作:<br> 在本机登入mysql后，更改 “mysql” 数据库里的 “user” 表里的 “host” 项，从”localhost”改称’%’即可,命令如下:</p>   <figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># 以权限用户root登录</div><div class="line">mysql -u root -p</div><div class="line">#查看mysql库中的user表的host值（即可进行连接访问的主机/IP名称）</div><div class="line"><span class="keyword">use</span> mysql;</div><div class="line"><span class="keyword">select</span> host <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="keyword">user</span>=<span class="string">'root'</span>;</div><div class="line"># 如果已经有%则无需更新</div><div class="line"># 修改host值（以通配符%的内容增加主机/IP地址），当然也可以直接增加IP地址  </div><div class="line"><span class="keyword">update</span> <span class="keyword">user</span> <span class="keyword">set</span> host = <span class="string">'%'</span> <span class="keyword">where</span> <span class="keyword">user</span> =<span class="string">'root'</span>;</div><div class="line"># 如果报Duplicate entry '%-root' for key 'PRIMARY'错说明表中已存在%，刷新下权限</div><div class="line"># 刷新MySQL的系统权限相关表</div><div class="line"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</div><div class="line"># 再重新查看user表时，是否有修改</div><div class="line"><span class="keyword">select</span> host <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="keyword">user</span>=<span class="string">'root'</span>;</div></pre></td></tr></table></figure><p>重启mysql服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/etc/rc.d/init.d/mysqld restart</div></pre></td></tr></table></figure><p>搞完上述3步后使用Navicat for MySQL链接，如果失败就继续上网查找其他解决方法吧</p><h3 id="web开发常用linux命令"><a href="#web开发常用linux命令" class="headerlink" title="web开发常用linux命令"></a>web开发常用linux命令</h3><h4 id="防火墙命令"><a href="#防火墙命令" class="headerlink" title="防火墙命令"></a>防火墙命令</h4><p>一般我们访问远程主机上的程序，如数据库，tomcat服务器，zookeeper等，如果未在防火墙中添加端口，可能无法访问，临时简单的解决方式就是关闭防火墙，这里简单介绍防火墙相关简单命令<br>永久性生效，重启后不会复原，命令如下:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"> <span class="comment"># 开启</span></div><div class="line">chkconfig iptables on</div><div class="line"> <span class="comment"># 关闭</span></div><div class="line">chkconfig iptables off</div></pre></td></tr></table></figure><p>即时生效，重启后复原,命令如下:</p><ol><li><p>查看防火墙状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service iptables status</div></pre></td></tr></table></figure></li><li><p>开启防火墙</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service iptables start</div></pre></td></tr></table></figure></li><li><p>关闭防火墙</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service iptables stop</div></pre></td></tr></table></figure></li></ol><h4 id="tomcat命令"><a href="#tomcat命令" class="headerlink" title="tomcat命令"></a>tomcat命令</h4><ol><li><p>查看日志</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 切换到tomcat安装主目录</span></div><div class="line"><span class="built_in">cd</span> tomcat</div><div class="line">tail -f  logs/catalina.out</div></pre></td></tr></table></figure></li><li><p>杀掉tomcat进程</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 8080代表tomcat的端口号 查看listen的进程号</span></div><div class="line">netstat -nap|grep 8080</div><div class="line"><span class="comment"># 杀掉进程 pid是listen的进程号</span></div><div class="line"><span class="built_in">kill</span> pid</div></pre></td></tr></table></figure></li></ol><h4 id="mysql相关命令"><a href="#mysql相关命令" class="headerlink" title="mysql相关命令"></a>mysql相关命令</h4><ol><li><p>mysql服务启动命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"> <span class="comment"># mysql服务启动/停止/重启</span></div><div class="line">/etc/rc.d/init.d/mysqld start/stop/restart</div></pre></td></tr></table></figure></li><li><p>运行sql文件</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 登入数据库后 切换到数据库，执行sql文件</div><div class="line">source /path/xxx.sql</div></pre></td></tr></table></figure></li><li><p>导出数据库  </p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># mysqldump -u 用户名 -p 数据库名 &gt; 导出的文件名   </div><div class="line">mysqldump -u root -p db_name &gt; db_name.sql</div></pre></td></tr></table></figure></li><li><p>导出表  </p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># mysqldump -u 用户名 -p 数据库名 该数据库下的表名&gt; 导出的文件名   </div><div class="line">mysqldump -u root -p db_name  tablename&gt; tablename.sql</div></pre></td></tr></table></figure></li></ol></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;web开发基本环境安装配置&quot;&gt;&lt;a href=&quot;#web开发基本环境安装配置&quot; class=&quot;headerlink&quot; title=&quot;web开发基本环境安装配置&quot;&gt;&lt;/a&gt;web开发基本环境安装配置&lt;/h3&gt;&lt;p&gt;  JavaWeb开发中生产环境一般都为linux，因此我们要具有在linux环境下搭建基本的JavaWeb开发常用环境的能力，本篇博客介绍的是linux环境下jdk的安装，tomcat的安装，及mysql数据库的安装&lt;br&gt;
    
    </summary>
    
      <category term="linux" scheme="https://yangshaoxiang.github.io/categories/linux/"/>
    
    
      <category term="linux" scheme="https://yangshaoxiang.github.io/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>log4j使用</title>
    <link href="https://yangshaoxiang.github.io/2017/12/09/log4jj%E4%BD%BF%E7%94%A8/"/>
    <id>https://yangshaoxiang.github.io/2017/12/09/log4jj使用/</id>
    <published>2017-12-09T14:44:21.000Z</published>
    <updated>2017-12-10T14:46:11.191Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-配置效果"><a href="#1-配置效果" class="headerlink" title="1. 配置效果"></a>1. 配置效果</h3><p>下面的log4j日志配置最终能达到的效果是对于全局日志可以根据级别输入到对应级别的日志文件中，注意低级别的日志文件会同时包含高级别的日志信息，例如info级别的日志文件会包含info，warn，error信息，对于一些重要的模块，可以单独输出到独立的文件夹文件中，同时对单独模块也可以像全局日志那样根据日志级别输入到对应文件中 也可以配置该模块日志信息是否同时输入到全局日志中<br><a id="more"></a></p><h3 id="2-样板Log4j配置示例"><a href="#2-样板Log4j配置示例" class="headerlink" title="2. 样板Log4j配置示例"></a>2. 样板Log4j配置示例</h3><p>这段配置的效果是配置3个全局的输出目的地，分别输出到控制台，和两个文件中，控制台的输出级别是info，两个文件的输出级别分别是info和error，配置一个login(登录)模块的日志输出到文件中，并且配置该模块日志信息不输出到全局日志中，在该模块中日志同样按照级别输出到不同文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line">log4j.rootLogger=DEBUG,console, infofile, errorfile</div><div class="line"></div><div class="line">#日志文件输出目录</div><div class="line">basedir=$&#123;catalina.home&#125;/logs/basemvc</div><div class="line">#登录模块日志输出目录</div><div class="line">logindir=$&#123;basedir&#125;/login</div><div class="line"></div><div class="line">#控制台日志-输出info以上</div><div class="line">log4j.appender.console=org.apache.log4j.ConsoleAppender</div><div class="line">log4j.appender.console.Threshold=info</div><div class="line">log4j.appender.console.layout=org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.console.layout.ConversionPattern=%d&#123;yyyy-MM-ddHH\:mm\:ss&#125;[%-5p]%m%n%n</div><div class="line"></div><div class="line">#文件中info级别以上日志</div><div class="line">log4j.appender.infofile=org.apache.log4j.DailyRollingFileAppender</div><div class="line">log4j.appender.infofile.Append=true</div><div class="line">log4j.appender.infofile.DatePattern=&apos;.&apos;yyyy-MM-dd</div><div class="line">log4j.appender.infofile.File=$&#123;basedir&#125;/info.log</div><div class="line">log4j.appender.infofile.Threshold=info</div><div class="line">log4j.appender.infofile.layout=org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.infofile.layout.ConversionPattern=%d&#123;yyyy-MM-ddHH\:mm\:ss&#125;[%-5p]%m%n%n</div><div class="line"></div><div class="line">#文件中error级别以上日志</div><div class="line">log4j.appender.errorfile=org.apache.log4j.DailyRollingFileAppender</div><div class="line">log4j.appender.errorfile.Append=true</div><div class="line">log4j.appender.errorfile.DatePattern=&apos;.&apos;yyyy-MM-dd</div><div class="line">log4j.appender.errorfile.File=$&#123;basedir&#125;/error.log</div><div class="line">log4j.appender.errorfile.Threshold=ERROR</div><div class="line">log4j.appender.errorfile.layout=org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.errorfile.layout.ConversionPattern=%d&#123;yyyy-MM-dd HH\:mm\:ss&#125; [%-5p] %m%n%n</div><div class="line"></div><div class="line">#--------------------以下login模块相关日志--------------------</div><div class="line">#login模块输出</div><div class="line">#INFO及以上级别的log进行输出</div><div class="line">log4j.logger.login=INFO,logininfofile,loginerrorfile</div><div class="line"></div><div class="line">#login模块文件中存储info级别以上日志        </div><div class="line">log4j.appender.logininfofile.Threshold=INFO</div><div class="line">#以文件类型输出</div><div class="line">log4j.appender.logininfofile=org.apache.log4j.DailyRollingFileAppender</div><div class="line">#输出路径</div><div class="line">log4j.appender.logininfofile.File=$&#123;logindir&#125;/info_login.log</div><div class="line">#配置文件输出的文件命名，这种格式文件会在凌晨生成一个文件，想在其他时间生成新文件可以查看DatePattern的相关配置</div><div class="line">log4j.appender.logininfofile.DatePattern=&apos;_&apos;yyyy-MM-dd&apos;.log&apos;</div><div class="line">#输出格式</div><div class="line">log4j.appender.logininfofile.layout=org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.logininfofile.layout.ConversionPattern=%d %p [%c] - %m%n</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">#login模块文件中存储error级别以上日志</div><div class="line">log4j.appender.loginerrorfile.Threshold=ERROR</div><div class="line">#以文件类型输出</div><div class="line">log4j.appender.loginerrorfile=org.apache.log4j.DailyRollingFileAppender</div><div class="line">#输出路径</div><div class="line">log4j.appender.loginerrorfile.File=$&#123;logindir&#125;/error_login.log</div><div class="line">#配置文件输出的文件命名，这种格式文件会在凌晨生成一个文件，想在其他时间生成新文件可以查看DatePattern的相关配置</div><div class="line">log4j.appender.loginerrorfile.DatePattern=&apos;_&apos;yyyy-MM-dd&apos;.log&apos;</div><div class="line">#输出格式</div><div class="line">log4j.appender.loginerrorfile.layout=org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.loginerrorfile.layout.ConversionPattern=%d %p [%c] - %m%n</div><div class="line"></div><div class="line">#设置这个子Logger输出日志不在父级别logger里面输出</div><div class="line">log4j.additivity.login=false</div><div class="line"></div><div class="line">#--------------------以上login模块相关日志--------------------</div></pre></td></tr></table></figure></p><h3 id="3-配置简要解释"><a href="#3-配置简要解释" class="headerlink" title="3. 配置简要解释"></a>3. 配置简要解释</h3><h4 id="3-1-关于全局日志的配置"><a href="#3-1-关于全局日志的配置" class="headerlink" title="3.1 关于全局日志的配置"></a>3.1 关于全局日志的配置</h4><ol><li><p>关于日志的输出级别<br> log4j日志级别分为OFF、FATAL、ERROR、WARN、INFO、DEBUG、ALL或者自定义的级别。Log4j建议只使用四个级别，优先级从高到低分别是 ERROR、WARN、INFO、DEBUG。通过在配置文件中配置，可以控制到应用程序中相应级别的日志信息的开关。比如在配置文件中定义了log4j.rootLogger为INFO级别，则应用程序中所有DEBUG级别的日志信息将不被打印出来，也是说大于等于的级别的日志才输出。</p></li><li><p>全局日志配置 log4j.rootLogger<br> 这个是用来定义日志全局的输出级别以及输出的目的地，这里我定义的是log4j.rootLogger=info, console, infofile, errorfile,这里定义了全局输出的日志为INFO级别，也就是说能输出的日志级别一定不低于INFO级别，即DEBUG级别的日志将不会输出，输出到哪呢?输出到紧接其后定义的目的地 console, infofile, errorfile，这个3个目的地可以随意命名，在每个目的地中可以具体细化日志的配置，即他们可以再次对日志的级别进行过滤，对日志输出格式进行细化，对日志输出端类型进行指定。</p></li><li><p>指定日志输出目的地中输出端 log4j.appender.目的地名称<br> 就是配置输出到这个目的地的日志，他是在控制台中输出，还是以文件的形式输出，如果以文件的形式输出，那么其文件产生时机是什么时候，目的地有如下几种配置:</p><blockquote><p>org.apache.log4j.ConsoleAppender（控制台）<br>org.apache.log4j.FileAppender（文件）<br>org.apache.log4j.DailyRollingFileAppender（每天产生一个日志文件）<br>org.apache.log4j.RollingFileAppender（文件大小到达指定尺寸的时候产生一个新的文件）<br>org.apache.log4j.WriterAppender（将日志信息以流格式发送到任意指定的地方）  </p></blockquote></li><li><p>指定日志输出目的地中日志输出级别 log4j.appender.interceptor.Threshold<br>通过该属性可以指定目的地中日志输出的级别，相当于对全局配置的日志级别再次做一次过滤</p></li></ol><h4 id="3-2-关于单独模块日志配置"><a href="#3-2-关于单独模块日志配置" class="headerlink" title="3.2 关于单独模块日志配置"></a>3.2 关于单独模块日志配置</h4><ol><li><p>log4j.logger.login.模块名<br>这一句配置相当于新添了一个日志模块，他的值与rootLogger代表意义相同，即指定相对该模块下全局日志级别及对应的输出目的地，其余对应目的地的配置和全局日志相同</p></li><li><p>log4j.additivity.模块名<br>设置这个子Logger输出日志是否在父级别logger里面输出，true表示同时在父级的日志输出，这里的模块名可以换为模块下的目的地名称，效果是一样的</p></li></ol><h3 id="4-java中使用日志"><a href="#4-java中使用日志" class="headerlink" title="4. java中使用日志"></a>4. java中使用日志</h3><p>   对于在java中使用，单独日志模块要想独立输出获取日志对象时在方法参数中要传入模块名称，对于全局日志对象只需传入当前类的class对象即可，代码示例如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserAction</span> </span>&#123;</div><div class="line">    <span class="comment">//登录模块使用的日志对象</span></div><div class="line">    <span class="keyword">private</span> Logger loginLogger = Logger.getLogger(<span class="string">"login"</span>);</div><div class="line">    <span class="comment">//全局日志对象</span></div><div class="line">    <span class="keyword">private</span> Logger logger = Logger.getLogger(UserAction.class);</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">detail</span><span class="params">()</span></span>&#123;</div><div class="line">        logger.debug(<span class="string">"user_product----"</span>+<span class="string">"debug"</span>);</div><div class="line">        logger.info(<span class="string">"user_product----"</span>+<span class="string">"info"</span>);</div><div class="line">        logger.warn(<span class="string">"user_product----"</span>+<span class="string">"warn"</span>);</div><div class="line">        logger.error(<span class="string">"user_product----"</span>+<span class="string">"error"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">login</span><span class="params">()</span></span>&#123;</div><div class="line">        loginLogger.debug(<span class="string">"user_product----"</span>+<span class="string">"debug"</span>);</div><div class="line">        loginLogger.info(<span class="string">"user_product----"</span>+<span class="string">"info"</span>);</div><div class="line">        loginLogger.warn(<span class="string">"user_product----"</span>+<span class="string">"warn"</span>);</div><div class="line">        loginLogger.error(<span class="string">"user_product----"</span>+<span class="string">"error"</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;1-配置效果&quot;&gt;&lt;a href=&quot;#1-配置效果&quot; class=&quot;headerlink&quot; title=&quot;1. 配置效果&quot;&gt;&lt;/a&gt;1. 配置效果&lt;/h3&gt;&lt;p&gt;下面的log4j日志配置最终能达到的效果是对于全局日志可以根据级别输入到对应级别的日志文件中，注意低级别的日志文件会同时包含高级别的日志信息，例如info级别的日志文件会包含info，warn，error信息，对于一些重要的模块，可以单独输出到独立的文件夹文件中，同时对单独模块也可以像全局日志那样根据日志级别输入到对应文件中 也可以配置该模块日志信息是否同时输入到全局日志中&lt;br&gt;
    
    </summary>
    
      <category term="java" scheme="https://yangshaoxiang.github.io/categories/java/"/>
    
    
      <category term="日志" scheme="https://yangshaoxiang.github.io/tags/%E6%97%A5%E5%BF%97/"/>
    
      <category term="log4j" scheme="https://yangshaoxiang.github.io/tags/log4j/"/>
    
  </entry>
  
  <entry>
    <title>linux下文件上传下载</title>
    <link href="https://yangshaoxiang.github.io/2017/12/09/linux%E4%B8%8B%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD/"/>
    <id>https://yangshaoxiang.github.io/2017/12/09/linux下文件上传下载/</id>
    <published>2017-12-09T14:44:21.000Z</published>
    <updated>2017-12-18T14:00:22.859Z</updated>
    
    <content type="html"><![CDATA[<h3 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h3><p>本篇博客主要介绍如何去链接远程的linux主机及如何实现本地与远程主机之间文件的上传下载操作，下面的linux系统是CentOS6.6<br><a id="more"></a></p><h4 id="链接远程linux主机"><a href="#链接远程linux主机" class="headerlink" title="链接远程linux主机"></a>链接远程linux主机</h4><p>  一般链接远程linux主机，如果电脑上没有安装类似SecureCRTPortable这种终端仿真程序，我们会用git的命令窗口使用命令去链接，但是这种方式不能保存链接的用户名和密码，下次还要重新输入链接信息，很麻烦，适合暂时的连一下，用一下，通常都会使用终端仿真程序，并保存相关链接信息。</p><h5 id="未安装终端仿真程序链接方式-命令"><a href="#未安装终端仿真程序链接方式-命令" class="headerlink" title="未安装终端仿真程序链接方式-命令"></a>未安装终端仿真程序链接方式-命令</h5><p>  在任意位置打开git命令窗口，输入如下命令即可<br>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh username@ip_or_domain</div></pre></td></tr></table></figure></p><p>  该命令中username代表linux登录用户的用户名，ip_or_domain代表linux主机的ip地址或ip所映射的域名，例如:<br>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh root@116.196.115.151</div></pre></td></tr></table></figure></p><p>  代表的含义是使用root用户链接116.196.115.151的远程主机<br>  之后，一般如果该账户设有密码，会在下一步提示输入链接密码，输入正确密码即可链接成功</p><h5 id="安装SecureCRTPortable链接"><a href="#安装SecureCRTPortable链接" class="headerlink" title="安装SecureCRTPortable链接"></a>安装SecureCRTPortable链接</h5><p>  本地电脑上有SecureCRTPortable这种终端仿真程序（直接浏览器搜索，一堆，本文使用版本为8.3），打开SecureCRTPortable，选择 文件(File)-&gt;快速连接(Quick Connect)，输入主机名和用户名，主机名就是远程linux主机的ip地址，用户名就是登陆的用户名，之后会弹出密码框，要求输入密码，成功后即可链接主机</p><h4 id="文件上传和下载"><a href="#文件上传和下载" class="headerlink" title="文件上传和下载"></a>文件上传和下载</h4><p> 大部分情况下，我们要在linux下安装的软件，或将要部署在linux环境服务器上的本地开发的应用，他们大部分情况下是在本地windows环境下的，这就涉及到如何将本地文件上传到linux系统中，还有就是在linux下修改一些配置文件非常的繁琐，一般对于比较大的配置文件可能会下载到本地修改，然后在上传覆盖，这就涉及到如何将linux上的文件下载到本地，这里介绍3种方式，个人推荐第三种rz/sz方式</p><h5 id="未安装任何的终端仿真程序-命令"><a href="#未安装任何的终端仿真程序-命令" class="headerlink" title="未安装任何的终端仿真程序-命令"></a>未安装任何的终端仿真程序-命令</h5><h6 id="命令上传"><a href="#命令上传" class="headerlink" title="命令上传:"></a>命令上传:</h6><p>  在本地打开要上传文件所在文件夹，打开该级文件夹下打开git命令窗口，输入如下命令：<br>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">scp filename username@ip_or_domain:/target_directory/</div></pre></td></tr></table></figure></p><p>   该命令中filename代表要上传的文件名称，username代表linux登录用户的用户名，ip_or_domain代表linux主机的ip地址或ip所映射的域名，target_directory代表linux下要上传到的文件目录,例如:<br>   <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">scp test.sql root@116.196.115.151:/root/</div></pre></td></tr></table></figure></p><p>  代表的含义是将当前目录下的test.sql文件复制上传到116.196.115.151主机的root目录下,如果有密码之后输入密码。</p><h6 id="命令下载"><a href="#命令下载" class="headerlink" title="命令下载:"></a>命令下载:</h6><p>   基本和命令上传相同，在本地先切换到盛放下载文件的目录，在该目录下打开git窗口，输入如下命令<br>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">scp username@ip_or_domain:/target_directory/filename ~/</div></pre></td></tr></table></figure></p><p>   该命令中username代表linux登录用户的用户名，ip_or_domain代表linux主机的ip地址或ip所映射的域名，target_directory代表linux下要下载的文件目录，filename代表要下载的文件名称，例如：<br>   <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">scp root@116.196.115.151:/root/test.sql  ~/Desktop/</div></pre></td></tr></table></figure></p><p>   代表的含义是将主机root目录下的test.sql文件下载到本地windows的桌面上</p><h6 id="对于目录的上传下载"><a href="#对于目录的上传下载" class="headerlink" title="对于目录的上传下载"></a>对于目录的上传下载</h6><p>   scp命令后面紧接着加上 -r 即可，后面的路径到目录一级即可</p><h6 id="对于两台linux主机之间文件互相拷贝"><a href="#对于两台linux主机之间文件互相拷贝" class="headerlink" title="对于两台linux主机之间文件互相拷贝"></a>对于两台linux主机之间文件互相拷贝</h6><p>   将上述上传或下载命令文件路径部分，在路径前面加上username@ip_or_domain:的前缀即可</p><h5 id="SecureCRTPortable的sftp"><a href="#SecureCRTPortable的sftp" class="headerlink" title="SecureCRTPortable的sftp"></a>SecureCRTPortable的sftp</h5><h6 id="SecureCRTPortable的sftp上传下载公共操作步骤"><a href="#SecureCRTPortable的sftp上传下载公共操作步骤" class="headerlink" title="SecureCRTPortable的sftp上传下载公共操作步骤:"></a>SecureCRTPortable的sftp上传下载公共操作步骤:</h6><ol><li><a href="#安装SecureCRTPortable链接">使用SecureCRTPortable链接到主机</a></li><li>使用快捷键alt+p,进入sftp界面</li><li><p>切换到存放上传文件(要下载的文件)的目录(cd命令)</p><h6 id="SecureCRTPortable的sftp上传"><a href="#SecureCRTPortable的sftp上传" class="headerlink" title="SecureCRTPortable的sftp上传:"></a>SecureCRTPortable的sftp上传:</h6></li><li>直接将本地文件拖拽到sftp界面窗口中即可(像qq发送文件那样，注意尽量使用较高版本   的SecureCRT，否则可能不支持拖拽，例如7.0的版本在win7下可拖拽，win10下不行，8.3的版本都可以)</li><li><p>传输完成后使用ls命令查看当前目录是否有上传的文件(ll命令不可用)</p><h6 id="SecureCRTPortable的sftp下载"><a href="#SecureCRTPortable的sftp下载" class="headerlink" title="SecureCRTPortable的sftp下载:"></a>SecureCRTPortable的sftp下载:</h6><ol><li>使用如下命令将文件下载到本地<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 指定本地下载目录 这里指定为d盘</span></div><div class="line">lcd d:\</div><div class="line"><span class="comment"># 使用get命令下载，后面跟要下载的文件名称(要先切换到文件所在目录)</span></div><div class="line">get test.sql</div></pre></td></tr></table></figure></li></ol></li></ol><h5 id="SecureCRTPortable的Zmodem"><a href="#SecureCRTPortable的Zmodem" class="headerlink" title="SecureCRTPortable的Zmodem"></a>SecureCRTPortable的Zmodem</h5><p>在linux任意目录下输入rz，如果出现 -bash: rz: command not found 说明未安装Zmodem，如果弹出一个文件选择框则已经安装，查看如何使用即可</p><h6 id="安装Zmodem"><a href="#安装Zmodem" class="headerlink" title="安装Zmodem:"></a>安装Zmodem:</h6><p>方式一(简单):执行如下命令，完毕即可使用<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install lrzsz</div></pre></td></tr></table></figure></p><p>方式二(麻烦):执行如下一系列操作:</p><ol><li><p>下载</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 切换到下载目录</span></div><div class="line"><span class="built_in">cd</span> /tmp</div><div class="line"><span class="comment"># 下载</span></div><div class="line">wget http://www.ohse.de/uwe/releases/lrzsz-0.12.20.tar.gz</div></pre></td></tr></table></figure><p>如果出现 wget: command not found，执行下面命令安装wget</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum -y install wget</div></pre></td></tr></table></figure><p>如果出现wget颁发证书过期用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wget --no-check-certificate  http://www.ohse.de/uwe/releases/lrzsz-0.12.20.tar.gz</div></pre></td></tr></table></figure></li><li><p>解压安装及创建软连接</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">tar zxvf lrzsz-0.12.20.tar.gz &amp;&amp; <span class="built_in">cd</span> lrzsz-0.12.20</div><div class="line">./configure &amp;&amp; make &amp;&amp; make install</div></pre></td></tr></table></figure><p>如果报错:no acceptable cc found in $PATH<br>执行下面命令:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install gcc gcc-c++ gcc-g77</div></pre></td></tr></table></figure><p>上面安装过程默认把lsz和lrz安装到了/usr/local/bin/目录下，现在我们并不能直接使用，下面创建软链接，并命名为rz/sz：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /usr/bin</div><div class="line">ln -s /usr/<span class="built_in">local</span>/bin/lrz rz</div><div class="line">ln -s /usr/<span class="built_in">local</span>/bin/lsz sz</div></pre></td></tr></table></figure></li></ol><h6 id="使用Zmodem"><a href="#使用Zmodem" class="headerlink" title="使用Zmodem:"></a>使用Zmodem:</h6><p> 指定上传目录与下载目录<br> 上传目录：使用rz指令，进行上传操作时，弹出的对话框，会默认定位到该目录下。<br> 下载目录：使用sz指令，进行下载操作后，所下载的文件，默认下载到该目录中。<br> 打开SecureCRT软件 -&gt; Options -&gt; session options -&gt; X/Y/Zmodem 下可以设置上传和下载的目录<br> sz filename:发送文件到客户端,zmodem接收可以自行启动，例如：<br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /root</div><div class="line">sz test.sql</div></pre></td></tr></table></figure></p><p> root下的test.sql文件会被发送到本地下载目录<br> rz :从客户端上传文件到linux服务端,输入该命令后会打开文件选择对话框(默认定位到上传目录)</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;基本操作&quot;&gt;&lt;a href=&quot;#基本操作&quot; class=&quot;headerlink&quot; title=&quot;基本操作&quot;&gt;&lt;/a&gt;基本操作&lt;/h3&gt;&lt;p&gt;本篇博客主要介绍如何去链接远程的linux主机及如何实现本地与远程主机之间文件的上传下载操作，下面的linux系统是CentOS6.6&lt;br&gt;
    
    </summary>
    
      <category term="linux" scheme="https://yangshaoxiang.github.io/categories/linux/"/>
    
    
      <category term="linux" scheme="https://yangshaoxiang.github.io/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>Activemq的安装及启动</title>
    <link href="https://yangshaoxiang.github.io/2017/10/20/Activemq%E7%9A%84%E5%AE%89%E8%A3%85%E5%8F%8A%E5%90%AF%E5%8A%A8/"/>
    <id>https://yangshaoxiang.github.io/2017/10/20/Activemq的安装及启动/</id>
    <published>2017-10-19T17:05:08.000Z</published>
    <updated>2017-12-10T07:23:30.776Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-基本了解"><a href="#1-基本了解" class="headerlink" title="1. 基本了解"></a>1. 基本了解</h3><p>&emsp;&emsp;这一部分内容主要来源网络，这里整理归纳到博客中，阅读之后对ActiveMq有一个基本的认知和了解。<br> &emsp; <strong>1. ActiveMQ概念</strong><br>&emsp;&emsp;ActiveMQ是Apache推出的，一款开源的，完全支持JMS1.1和J2EE 1.4规范的JMSProvider实现的消息中间件（Message Oriented Middleware，MOM）。<br><a id="more"></a><br>&emsp; <strong>2. ActiveMQ作用</strong><br>&emsp;&emsp;最主要的功能就是：实现JMS Provider，用来帮助实现高可用、高性能、可伸缩、易用和安全的企业级面向消息服务的系统。</p><p>&emsp; <strong>3. ActiveMQ特点</strong></p><ul><li>完全支持JMS1.1和J2EE 1.4规范 （持久化，XA消息，事务)  </li><li>支持多种传送协议：in-VM,TCP,SSL,NIO,UDP,JGroups,JXTA  </li><li>可插拔的体系结构，可以灵活定制，如：消息存储方式、安全管理等  </li><li>很容易和Application Server集成使用</li><li>多种语言和协议编写客户端。语言: Java,C,C++,C#,Ruby,Perl,Python,PHP</li><li>从设计上保证了高性能的集群，客户端-服务器，点对点</li><li>可以很容易的和Spring结合使用</li><li>支持通过JDBC和journal提供高速的消息持久化</li></ul><h3 id="2-基本安装和配置"><a href="#2-基本安装和配置" class="headerlink" title="2. 基本安装和配置"></a>2. 基本安装和配置</h3><p>&emsp;&emsp;这一部分阅读后了解activemq在windows和linux下的安装和基本配置。<br>&emsp;&emsp;<strong>windows下activemq的安装</strong><br>&emsp;&emsp;1.到官网<a href="http://activemq.apache.org/download.html" target="_blank" rel="external">下载activemq</a>，windows下下载zip包，linux下下载gz包，这里下载的是5.15.0的版本。<br>&emsp;&emsp;2.解压到任意目录，但是看官网说如果文件路径过长可能会有问题，为求稳妥，目录不要放的过深。<br>&emsp;&emsp;3.到activimq解压目录下的bin目录中的win64去运行activemq.bat(我的电脑是win7 64位)，直接运行bin目录下的activemq.bat我的会直接闪退,注意activemq的启动需要jdk的环境。<br>&emsp;&emsp;4.启动成功后，在浏览器中输入:<a href="http://localhost:8161/admin/" target="_blank" rel="external">http://localhost:8161/admin/</a> 打开activemq的管控台，用户名和密码默认都是admin，登陆进去后可看到管控界面。<br>&emsp;&emsp;<strong>windows下activemq的简单配置</strong><br>&emsp;&emsp;1.管控台密码配置，也就是上面输入的admin<br>&emsp;&emsp;&emsp;&emsp;在安装目录下的<code>conf/jetty.xml</code>中有如下内容<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"securityConstraint"</span> <span class="attr">class</span>=<span class="string">"org.eclipse.jetty.util.security.Constraint"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"BASIC"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"roles"</span> <span class="attr">value</span>=<span class="string">"admin"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"authenticate"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p><p>&emsp;&emsp;&emsp;&emsp;确保 authenticate 的值为true(默认就为true)<br>&emsp;&emsp;&emsp;&emsp;控制台的登录用户名密码保存在<code>conf/jetty-realm.properties</code>文件中,内容如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># Defines users that can access the web (console, demo, etc.)</div><div class="line"># username: password [,rolename ...]</div><div class="line">#用户名 : 密码 ,角色名</div><div class="line">admin: newpwd, admin</div></pre></td></tr></table></figure></p><p>&emsp;&emsp;2.安全配置（消息安全）<br>&emsp;&emsp;&emsp;&emsp;ActiveMQ 如果不加入安全机制的话，任何人只要知道消息服务的具体地址(包括 ip，端口，消息地址[队列或者主题地址])，就可以任意的发送、接收消息。关于 ActiveMQ 的安全可以参考官方的<a href="http://activemq.apache.org/security.html" target="_blank" rel="external">安全配置方式</a>,我们这里使用配置简单授权方式:<br>&emsp;&emsp;&emsp;&emsp;在 <code>conf/activemq.xml</code> 文件中在 broker 标签最后加入以下内容即可：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">simpleAuthenticationPlugin</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">users</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">authenticationUser</span> <span class="attr">username</span>=<span class="string">"yourname"</span> <span class="attr">password</span>=<span class="string">"yourpwd"</span> <span class="attr">groups</span>=<span class="string">"users,admins"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">users</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">simpleAuthenticationPlugin</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div></pre></td></tr></table></figure></p><p>&emsp;&emsp;&emsp;&emsp;这里定义用户名为 yourname，密码为 yourpwd，角色为 users,admins,如果这里做了配置，那么在编写客户端创建连接工厂时需要指定用户名和密码，在之后的代码中会注释说明。注意配置了这个之后，浏览器的控制台就无法查看该队列的信息了(我这里是无法查看了)  </p><p>&emsp;&emsp;<strong>linux(CentOS)下activemq的安装</strong><br>&emsp;&emsp;1.到官网<a href="http://activemq.apache.org/download.html" target="_blank" rel="external">下载activemq</a>，windows下下载zip包，linux下下载gz包，这里下载的是5.15.0的版本。<br>&emsp;&emsp;2.将下载的gz包上传至linux系统中，也可以直接在linux的存放目录下直接下载<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wget http://59.109.99.40/IXC492c5648ba8654fcfe0e8dd805738eb4/apache//activemq/5.15.1/apache-activemq-5.15.1-bin.tar.gz</div></pre></td></tr></table></figure></p><p>&emsp;&emsp;3.解压安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tar -zxvf apache-activemq-5.15.1-bin.tar.gz</div></pre></td></tr></table></figure></p><p>&emsp;&emsp;4.启动执行:进入解压后的目录的bin目录中，如果启动脚本 activemq 没有可执行权限，此时则需要授权，执行如下命令即可:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chmod 755 ./activemq</div></pre></td></tr></table></figure></p><p>&emsp;&emsp;5.防火墙中打开对应的端口:ActiveMQ 需要用到两个端口,<br>一个是消息通讯的端口（默认为 61616）,<br>一个是管理控制台端口（默认为 8161）可在 <code>conf/jetty.xml</code> 中修改，默认如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jettyPort"</span> <span class="attr">class</span>=<span class="string">"org.apache.activemq.web.WebConsolePort"</span> <span class="attr">init-method</span>=<span class="string">"start"</span>&gt;</span></div><div class="line"><span class="comment">&lt;!-- the default port number for the web console --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"host"</span> <span class="attr">value</span>=<span class="string">"0.0.0.0"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"port"</span> <span class="attr">value</span>=<span class="string">"8161"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p><p>&emsp;&emsp;在防火墙中添加端口命令如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /etc/sysconfig/iptables</div></pre></td></tr></table></figure></p><p>&emsp;&emsp;在文件中添加如下配置:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">-A INPUT -m state --state NEW -m tcp -p tcp --dport 61616 -j ACCEPT</div><div class="line">-A INPUT -m state --state NEW -m tcp -p tcp --dport 8161 -j ACCEPT</div></pre></td></tr></table></figure></p><p>&emsp;&emsp;重启防火墙，启动ActiveMQ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">service iptables restart</div><div class="line">./activemq start</div></pre></td></tr></table></figure></p><p>&emsp;&emsp;在浏览器上访问:<a href="http://linux的IP地址:8161" target="_blank" rel="external">http://linux的IP地址:8161</a>  用户名及密码默认都为admin</p><p>&emsp;&emsp;<strong>linux下activemq配置和说明同windows相同</strong><br>&emsp;&emsp;1.管控台密码配置，也就是进入网页管控台时输入的admin<br>&emsp;&emsp;&emsp;&emsp;在安装目录下的<code>conf/jetty.xml</code>中有如下内容<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"securityConstraint"</span> <span class="attr">class</span>=<span class="string">"org.eclipse.jetty.util.security.Constraint"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"BASIC"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"roles"</span> <span class="attr">value</span>=<span class="string">"admin"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"authenticate"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p><p>&emsp;&emsp;&emsp;&emsp;确保 authenticate 的值为true(默认就为true)<br>&emsp;&emsp;&emsp;&emsp;控制台的登录用户名密码保存在<code>conf/jetty-realm.properties</code>文件中,要执行的命令及文件内容如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd ../</div><div class="line">vi conf/jetty-realm.properties</div></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># Defines users that can access the web (console, demo, etc.)</div><div class="line"># username: password [,rolename ...]</div><div class="line">#用户名 : 密码 ,角色名</div><div class="line">admin: newpwd, admin</div></pre></td></tr></table></figure><p>&emsp;&emsp;2.安全配置（消息安全）<br>&emsp;&emsp;&emsp;&emsp;ActiveMQ 如果不加入安全机制的话，任何人只要知道消息服务的具体地址(包括 ip，端口，消息地址[队列或者主题地址])，就可以任意的发送、接收消息。关于 ActiveMQ 的安全可以参考官方的<a href="http://activemq.apache.org/security.html" target="_blank" rel="external">安全配置方式</a>,我们这里使用配置简单授权方式:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi conf/activemq.xml</div></pre></td></tr></table></figure></p><p>  &emsp;&emsp;为了activeMQ的消息安全性在 <code>conf/activemq.xml</code> 文件中的 broker 标签最后加入以下内容后保存退出(按esc键,按shift+:键,输入wq,按enter键)：<br> <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">simpleAuthenticationPlugin</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">users</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">authenticationUser</span> <span class="attr">username</span>=<span class="string">"yourname"</span> <span class="attr">password</span>=<span class="string">"yourpwd"</span> <span class="attr">groups</span>=<span class="string">"users,admins"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">users</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">simpleAuthenticationPlugin</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div></pre></td></tr></table></figure></p><p> &emsp;&emsp;这里定义用户名为 yourname，密码为 yourpwd，角色为 users,admins,如果这里做了配置，那么在编写客户端创建连接工厂时需要指定用户名和密码，在之后的代码中会注释说明。注意配置了这个之后，浏览器的控制台就无法查看该队列的信息了(我这里是无法查看了)    </p><p> &emsp;&emsp;以上关于ActiveMQ的在windows和linux环境下的安装及简单配置，整理完收工。</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;1-基本了解&quot;&gt;&lt;a href=&quot;#1-基本了解&quot; class=&quot;headerlink&quot; title=&quot;1. 基本了解&quot;&gt;&lt;/a&gt;1. 基本了解&lt;/h3&gt;&lt;p&gt;&amp;emsp;&amp;emsp;这一部分内容主要来源网络，这里整理归纳到博客中，阅读之后对ActiveMq有一个基本的认知和了解。&lt;br&gt; &amp;emsp; &lt;strong&gt;1. ActiveMQ概念&lt;/strong&gt;&lt;br&gt;&amp;emsp;&amp;emsp;ActiveMQ是Apache推出的，一款开源的，完全支持JMS1.1和J2EE 1.4规范的JMSProvider实现的消息中间件（Message Oriented Middleware，MOM）。&lt;br&gt;
    
    </summary>
    
      <category term="java" scheme="https://yangshaoxiang.github.io/categories/java/"/>
    
    
      <category term="中间件" scheme="https://yangshaoxiang.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
      <category term="ActiveMQ" scheme="https://yangshaoxiang.github.io/tags/ActiveMQ/"/>
    
  </entry>
  
  <entry>
    <title>java后台常用json解析工具问题小结</title>
    <link href="https://yangshaoxiang.github.io/2017/10/20/java%E5%90%8E%E5%8F%B0%E5%B8%B8%E7%94%A8json%E8%A7%A3%E6%9E%90%E5%B7%A5%E5%85%B7%E9%97%AE%E9%A2%98%E5%B0%8F%E7%BB%93/"/>
    <id>https://yangshaoxiang.github.io/2017/10/20/java后台常用json解析工具问题小结/</id>
    <published>2017-10-19T17:05:08.000Z</published>
    <updated>2018-01-25T15:00:30.202Z</updated>
    
    <content type="html"><![CDATA[<h3 id="问题概述"><a href="#问题概述" class="headerlink" title="问题概述"></a>问题概述</h3><p>  问题基本是关于java对象转json时，非规范的java成员变量名引起的问题，这里不细究造成这些问题的底层原因，只是单纯的描述我碰到的问题及对应的解决方法<br>  <a id="more"></a></p><h3 id="jackson将java对象转json字符串字段字母小写问题"><a href="#jackson将java对象转json字符串字段字母小写问题" class="headerlink" title="jackson将java对象转json字符串字段字母小写问题"></a>jackson将java对象转json字符串字段字母小写问题</h3><p>  在使用springmvc框架作为后台控制层层的框架时，我们都知道当前台发送ajax请求后台要返回一个json字符串时，我们要做3件事</p><ol><li>引入jackson相关jar包</li><li>springmvc配置文件配置相关json转换配置</li><li>Controller层的方法上加上@Response注解，方法返回值为对象  </li></ol><p>这样当我们完成第三步，返回java对象之后，springmvc使用jackson将我们的对象转为json返回给前台，一般情况下是任何问题都不会发生的，但是当我们返回的java对象，他的成员变量不符合java驼峰命名规范时，会出现问题，例如当成员变量名全部大写，转化的json对应字段却是小写</p><p>java类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">  <span class="comment">//不符合变量命名规范的java类</span></div><div class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SellPoint</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String WT;</div><div class="line">    <span class="keyword">private</span> String ZT;</div><div class="line">      <span class="comment">//get/set ......略</span></div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="comment">//加注解之后的java类</span></div><div class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SellPoint</span> </span>&#123;</div><div class="line">    <span class="meta">@JsonProperty</span>(<span class="string">"WT"</span>)</div><div class="line">    <span class="keyword">private</span> String WT;</div><div class="line">    <span class="meta">@JsonProperty</span>(<span class="string">"ZT"</span>)</div><div class="line">    <span class="keyword">private</span> String ZT;</div><div class="line">     <span class="comment">//get/set 方法加@JsonIgnore</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>转化为json后<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">//不符合变量命名规范的java类转化的json</div><div class="line">"sellPoint": &#123;</div><div class="line">  "wt": "送20M宽带加电信电视（省内流量不限量，路由器、2部机顶盒免费送，预存400元）",</div><div class="line">  "zt": "送2T云存储空间；机顶盒免费用"</div><div class="line">&#125;</div><div class="line"></div><div class="line">//加完注解后正常的json</div><div class="line">"sellPoint": &#123;</div><div class="line">  "WT": "送20M宽带加电信电视（省内流量不限量，路由器、2部机顶盒免费送，预存400元）",</div><div class="line">  "ZT": "送2T云存储空间；机顶盒免费用"</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>解决方案:  </p><ol><li>在不规范的成员变量字段上加JsonProperty(“期望的变量名称”)注解</li><li>在对应的get/set方法上添加@JsonIgnore注解，忽略正常的转化</li></ol><p>注意：如果不在get/set方法加@JsonIgnore注解，会生成两份json属性，如下：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">"sellPoint": &#123;</div><div class="line">  "wt": "送20M宽带加电信电视（省内流量不限量，路由器、2部机顶盒免费送，预存400元）",</div><div class="line">  "zt": "送2T云存储空间；机顶盒免费用",</div><div class="line">  "WT": "送20M宽带加电信电视（省内流量不限量，路由器、2部机顶盒免费送，预存400元）",</div><div class="line">  "ZT": "送2T云存储空间；机顶盒免费用"</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3 id="fastjson将对象转化为json字符串首字母小写问题-未实践"><a href="#fastjson将对象转化为json字符串首字母小写问题-未实践" class="headerlink" title="fastjson将对象转化为json字符串首字母小写问题(未实践)"></a>fastjson将对象转化为json字符串首字母小写问题(未实践)</h3><p>解决方案一:<br>在Controller或service中初始化fastjson的一个参数（高版本(2.X)fastjson已经不适用）<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span>&#123;</div><div class="line">   TypeUtils.compatibleWithJavaBean = <span class="keyword">true</span>;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p><p>解决方案二:<br>新建fastjson.properties，添加如下配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fastjson.compatibleWithJavaBean=true</div></pre></td></tr></table></figure></p><p>解决方案三：<br>在对应字段上加@JSONField注解<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//加注解之后的java类</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SellPoint</span> </span>&#123;</div><div class="line">  <span class="meta">@JSONField</span>(<span class="string">"WT"</span>)</div><div class="line">  <span class="keyword">private</span> String WT;</div><div class="line">  <span class="meta">@JSONField</span>(<span class="string">"ZT"</span>)</div><div class="line">  <span class="keyword">private</span> String ZT;</div><div class="line">   <span class="comment">//get/set 忽略</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>ps:net.sf.json将对象转化为json不会出现属性名称问题</p><h3 id="net-sf-json的NoSuchMethodException-Unknown-property-XXXX"><a href="#net-sf-json的NoSuchMethodException-Unknown-property-XXXX" class="headerlink" title="net.sf.json的NoSuchMethodException: Unknown property XXXX"></a>net.sf.json的NoSuchMethodException: Unknown property XXXX</h3><p>这个错是使用net.sf.json将json字符串转化为java对象时出现，出现的原因是Json字符串属性过多，没有对应上javaBean的属性，所以程序会抛异常没有对应的属性。<br>解决方案是写一个属性过滤器<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">  JsonConfig config = <span class="keyword">new</span> JsonConfig();</div><div class="line">config.setJavaPropertyFilter(<span class="keyword">new</span> PropertyFilter()&#123;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">apply</span><span class="params">(Object paramObject1, String paramString,</span></span></div><div class="line"><span class="function"><span class="params">Object paramObject2)</span> </span>&#123;</div><div class="line">      <span class="comment">//这里设置要过滤的属性</span></div><div class="line"><span class="keyword">if</span>(paramString.equals(<span class="string">"xxx"</span>)||paramString.equals(<span class="string">"xxxx"</span>))&#123;</div><div class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;&#125;);</div></pre></td></tr></table></figure></p><p>这种方式可以参考<a href="https://my.oschina.net/heweipo/blog/368116" target="_blank" rel="external">这篇博客</a><br>我的json属性过多最终没有采用net.sf.json，使用了fastjson，他在json转java中，对于json中一些java没有的属性自动进行忽略</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;问题概述&quot;&gt;&lt;a href=&quot;#问题概述&quot; class=&quot;headerlink&quot; title=&quot;问题概述&quot;&gt;&lt;/a&gt;问题概述&lt;/h3&gt;&lt;p&gt;  问题基本是关于java对象转json时，非规范的java成员变量名引起的问题，这里不细究造成这些问题的底层原因，只是单纯的描述我碰到的问题及对应的解决方法&lt;br&gt;
    
    </summary>
    
      <category term="java" scheme="https://yangshaoxiang.github.io/categories/java/"/>
    
    
      <category term="java" scheme="https://yangshaoxiang.github.io/tags/java/"/>
    
      <category term="json" scheme="https://yangshaoxiang.github.io/tags/json/"/>
    
  </entry>
  
</feed>
